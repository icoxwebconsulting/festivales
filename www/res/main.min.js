var app=angular.module("interestelar",["ionic","ngCordova","ngCordovaOauth","angular.filter","ngStorage","ngResource","ngTwitter","spotify","ionic-zoom-view","angularMoment"]);app.run(function($rootScope,$state,$stateParams,$ionicPlatform,$ionicHistory,$state,DBService,UserService,NotificationService,$cordovaGoogleAnalytics){$ionicPlatform.ready(function(){function _waitForAnalytics(){"undefined"!=typeof analytics?($cordovaGoogleAnalytics.debugMode(),$cordovaGoogleAnalytics.startTrackerWithId("UA-57340953-2"),$cordovaGoogleAnalytics.trackView("Open app")):setTimeout(function(){_waitForAnalytics()},250)}DBService.init(!0),_waitForAnalytics(),window.cordova&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleLightContent(),$ionicPlatform.registerBackButtonAction(function(event){if("base.login"==$state.current.name||"base.register"==$state.current.name||"menu.artist-discover"==$state.current.name)event.preventDefault(),navigator.app.exitApp();else switch(event.preventDefault(),$ionicHistory.currentView().stateId){case"menu.artist-list":$ionicHistory.clearHistory(),$state.go("menu.artist-discover");break;case"menu.poster":$ionicHistory.clearHistory(),$state.go("menu.artist-discover");break;case"menu.schedule":$ionicHistory.clearHistory(),$state.go("menu.artist-discover");break;case"menu.map":$ionicHistory.clearHistory(),$state.go("menu.artist-discover");break;case"menu.ticket":$ionicHistory.clearHistory(),$state.go("menu.artist-discover");break;case"menu.coolway":$ionicHistory.clearHistory(),$state.go("menu.artist-discover");break;case"menu.info":$ionicHistory.clearHistory(),$state.go("menu.artist-discover");break;case"menu.social":$ionicHistory.clearHistory(),$state.go("menu.artist-discover");break;default:$ionicHistory.goBack()}},100),UserService.isLogged()?UserService.registerNotifications():($state.go("base.login"),console.info("redirect login")),$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){"base.login"!=toState.name&&"base.register"!=toState.name||!UserService.isLogged()||(event.preventDefault(),navigator.app.exitApp())})})}),app.config(function($stateProvider,$urlRouterProvider,$ionicConfigProvider){$ionicConfigProvider.backButton.text("").icon("my-back-button"),$stateProvider.state("base",{url:"/",abstract:!0,templateUrl:"templates/base.html",controller:"BaseController"}).state("base.login",{url:"login",views:{content:{templateUrl:"templates/user/sign_in.html",controller:"LoginController",resolve:{data:function($ionicPlatform,UserService,$state,$cordovaGoogleAnalytics){$ionicPlatform.ready(function(){function _waitForAnalytics(){"undefined"!=typeof analytics?$cordovaGoogleAnalytics.trackView("Login screen"):setTimeout(function(){_waitForAnalytics()},250)}_waitForAnalytics(),UserService.isLogged()?($state.go("menu.artist-discover"),console.info("is logged")):console.info("is not logged")})}}}}}).state("base.register",{url:"register",views:{content:{templateUrl:"templates/user/sign_up.html",controller:"RegisterController",resolve:{data:function($ionicPlatform,UserService,$state,$cordovaGoogleAnalytics){function _waitForAnalytics(){"undefined"!=typeof analytics?$cordovaGoogleAnalytics.trackView("Register screen"):setTimeout(function(){_waitForAnalytics()},250)}_waitForAnalytics(),$ionicPlatform.ready(function(){UserService.isLogged()?($state.go("menu.artist-discover"),console.info("is logged")):console.info("is not logged")})}}}}}).state("base.recover",{url:"recover",views:{content:{templateUrl:"templates/user/recover_password.html",controller:"RecoverController",resolve:{data:function($ionicPlatform,UserService,$state){$ionicPlatform.ready(function(){UserService.isLogged()?($state.go("menu.artist-discover"),console.info("is logged")):console.info("is not logged")})}}}}}).state("menu",{url:"/app/",abstract:!0,templateUrl:"templates/menu/main.html",controller:"MenuController"}).state("menu.artist-discover",{url:"artists/discover",views:{content:{templateUrl:"templates/artist/main.html",controller:"ArtistController",resolve:{data:function($ionicPlatform,$cordovaGoogleAnalytics){function _waitForAnalytics(){"undefined"!=typeof analytics?$cordovaGoogleAnalytics.trackView("Artist home screen"):setTimeout(function(){_waitForAnalytics()},250)}_waitForAnalytics()}}}}}).state("menu.artist-list",{url:"artists",views:{content:{templateUrl:"templates/artist/list.html",controller:"ArtistController",resolve:{data:function($ionicPlatform,$cordovaGoogleAnalytics){function _waitForAnalytics(){"undefined"!=typeof analytics?$cordovaGoogleAnalytics.trackView("Artist list screen"):setTimeout(function(){_waitForAnalytics()},250)}_waitForAnalytics()}}}}}).state("menu.artist-detail",{url:"artist/:id",views:{content:{templateUrl:"templates/artist/detail.html",controller:"ArtistController",resolve:{data:function($ionicPlatform,$cordovaGoogleAnalytics){function _waitForAnalytics(){"undefined"!=typeof analytics?$cordovaGoogleAnalytics.trackView("Artist detail screen"):setTimeout(function(){_waitForAnalytics()},250)}_waitForAnalytics()}}}}}).state("menu.poster",{url:"poster",views:{content:{templateUrl:"templates/poster/main.html",controller:"PosterController",resolve:{data:function($ionicPlatform,$cordovaGoogleAnalytics){function _waitForAnalytics(){"undefined"!=typeof analytics?$cordovaGoogleAnalytics.trackView("Poster screen"):setTimeout(function(){_waitForAnalytics()},250)}_waitForAnalytics()}}}}}).state("menu.schedule",{url:"schedule",views:{content:{templateUrl:"templates/schedule/main.html",controller:"ScheduleController",resolve:{data:function($ionicPlatform,$cordovaGoogleAnalytics){function _waitForAnalytics(){"undefined"!=typeof analytics?$cordovaGoogleAnalytics.trackView("Schedule screen"):setTimeout(function(){_waitForAnalytics()},250)}_waitForAnalytics()}}}}}).state("menu.map",{url:"map",views:{content:{templateUrl:"templates/map/main.html",controller:"MapController",resolve:{data:function($ionicPlatform,$cordovaGoogleAnalytics){function _waitForAnalytics(){"undefined"!=typeof analytics?$cordovaGoogleAnalytics.trackView("Map screen"):setTimeout(function(){_waitForAnalytics()},250)}_waitForAnalytics()}}}}}).state("menu.ticket",{url:"ticket",views:{content:{templateUrl:"templates/ticket/main.html",controller:"TicketController",resolve:{data:function($ionicPlatform,$cordovaGoogleAnalytics){function _waitForAnalytics(){"undefined"!=typeof analytics?$cordovaGoogleAnalytics.trackView("Ticket screen"):setTimeout(function(){_waitForAnalytics()},250)}_waitForAnalytics()}}}}}).state("menu.coolway",{url:"coolway",views:{content:{templateUrl:"templates/coolway/main.html",controller:"CoolwayController",resolve:{data:function($ionicPlatform,$cordovaGoogleAnalytics){function _waitForAnalytics(){"undefined"!=typeof analytics?$cordovaGoogleAnalytics.trackView("Coolway screen"):setTimeout(function(){_waitForAnalytics()},250)}_waitForAnalytics()}}}}}).state("menu.foodies",{url:"foodies",views:{content:{templateUrl:"templates/foodies/main.html",controller:"FoodiesController",resolve:{data:function($ionicPlatform,$cordovaGoogleAnalytics){function _waitForAnalytics(){"undefined"!=typeof analytics?$cordovaGoogleAnalytics.trackView("Foodies list screen"):setTimeout(function(){_waitForAnalytics()},250)}_waitForAnalytics()}}}}}).state("menu.foodies-detail",{url:"foodies/:id",views:{content:{templateUrl:"templates/foodies/detail.html",controller:"FoodiesController",resolve:{data:function($ionicPlatform,$cordovaGoogleAnalytics){function _waitForAnalytics(){"undefined"!=typeof analytics?$cordovaGoogleAnalytics.trackView("Foodies detail screen"):setTimeout(function(){_waitForAnalytics()},250)}_waitForAnalytics()}}}}}).state("menu.info",{url:"info",views:{content:{templateUrl:"templates/info/main.html",controller:"InfoController",resolve:{data:function($ionicPlatform,$cordovaGoogleAnalytics){function _waitForAnalytics(){"undefined"!=typeof analytics?$cordovaGoogleAnalytics.trackView("Info screen"):setTimeout(function(){_waitForAnalytics()},250)}_waitForAnalytics()}}}}}).state("menu.map-how-get",{url:"map-how-get",views:{content:{templateUrl:"templates/info/map.html",controller:"MapHowGetController",resolve:{data:function($ionicPlatform,$cordovaGoogleAnalytics){function _waitForAnalytics(){"undefined"!=typeof analytics?$cordovaGoogleAnalytics.trackView("Map Info screen"):setTimeout(function(){_waitForAnalytics()},250)}_waitForAnalytics()}}}}}).state("menu.sponsor",{url:"sponsor",views:{content:{templateUrl:"templates/info/sponsor.html"}}}).state("menu.weather",{url:"weather",views:{content:{templateUrl:"templates/info/weather.html"}}}).state("menu.social",{url:"social",views:{content:{templateUrl:"templates/social/main.html",controller:"SocialController",resolve:{data:function($ionicPlatform,$cordovaGoogleAnalytics){function _waitForAnalytics(){"undefined"!=typeof analytics?$cordovaGoogleAnalytics.trackView("Social screen"):setTimeout(function(){_waitForAnalytics()},250)}_waitForAnalytics()}}}}}),$urlRouterProvider.otherwise("/app/artists/discover"),$ionicConfigProvider.views.maxCache(0)}),app.constant("DB_CONFIG",{name:"interestelar",tables:[{name:"artists",erasable:!0,columns:[{name:"id",type:"integer"},{name:"name",type:"text UNIQUE"},{name:"description",type:"text"},{name:"image_profile",type:"text"},{name:"image_cover",type:"text"},{name:"stage_id",type:"text"},{name:"stage_name",type:"text"},{name:"schedule",type:"text"},{name:"spotify_id",type:"text"},{name:"facebook",type:"text"},{name:"twitter",type:"text"},{name:"instagram",type:"text"}]},{name:"favorites",erasable:!1,columns:[{name:"artist_id",type:"integer"},{name:"user_id",type:"integer"}]},{name:"posters",erasable:!0,columns:[{name:"id",type:"integer PRIMARY KEY UNIQUE"},{name:"image",type:"text UNIQUE"}]},{name:"maps",erasable:!0,columns:[{name:"id",type:"integer PRIMARY KEY AUTOINCREMENT"},{name:"name",type:"text"},{name:"image",type:"text"},{name:"latitude",type:"text"},{name:"longitude",type:"text"}]},{name:"locations",erasable:!0,columns:[{name:"id",type:"integer PRIMARY KEY AUTOINCREMENT"},{name:"name",type:"text"},{name:"detail",type:"text"},{name:"image",type:"text"},{name:"latitude",type:"text"},{name:"longitude",type:"text"}]}]}),app.constant("GLOBAL",{api:{url:"http://gravedadprod.mobi/app_dev.php/api/",version:"v1",feast:5},server:{image:"http://gravedadprod.mobi/uploads/"},spotify:{country_iso:"ES",user_id:"interestelarsevilla",client_id:"2f375c768116422aa8c4e31d4165c34b",playlist_id:"2poZ8QqUhxexHx6MT8JXSW"},facebook:{api_version:"v2.5",user_id:"1670312023215494",client_id:"176626989445422",client_secret:"a67cc1ceea3f86eece8b8f11bf11fbbd"},twitter:{screen_name:"InterestelarSev",client_id:"DdaAG4427damW3kOk5O3GDwXr",client_secret:"6ft5v8DS7aZ2KqhbDPtc2vz6o4eka7IeweXaGMPRICgCbe9ZYr"},instagram:{user_id:"2234302526",client_id:"56fd33cfcc54452eac65742adf6aaaa0",token:"49993566.6ed3bd5.e38eade499524ff5b66b90c7cf9fa87b"}}),app.factory("ArtistService",function($rootScope,$resource,GLOBAL,DBService){function add(artist){var sql="INSERT OR IGNORE INTO artists (id, name, description, image_profile, image_cover, stage_id,  stage_name, schedule, spotify_id, facebook, twitter, instagram) VALUES(?,?,?,?,?,?,?,?,?,?,?,?)";artist.name.toUpperCase().charCodeAt(0)>90&&(artist.name="!"+artist.name);var params=[artist.id,artist.name,artist.description,artist.image_profile,artist.image_cover,artist.stage_id,artist.stage_name,artist.schedule.date,artist.spotify_id,artist.facebook,artist.twitter,artist.instagram];return DBService.query(sql,params).then(function(response){return response}).catch(function(error){console.log(error)})}function drop(){return DBService.query("DROP TABLE IF EXISTS artists").then(function(result){return DBService.fetch(result)})}function getAll(){return DBService.query("SELECT * FROM artists").then(function(result){return DBService.fetchAll(result)})}function getFavorites(ids){var args="";for(i=1;i<=ids.length;i++)args+="?",i<ids.length&&(args+=",");var sql="SELECT * FROM artists WHERE id IN ("+args+")";return DBService.query(sql,ids).then(function(result){return DBService.fetchAll(result)}).catch(function(error){console.log(error)})}function getById(id){return DBService.query("SELECT * FROM artists WHERE id = ?",[id]).then(function(result){return DBService.fetch(result)})}var resource=$resource(GLOBAL.api.url+GLOBAL.api.version+"/artists",{},{getAll:{method:"GET",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/artists/"+GLOBAL.api.feast}});return{resource:resource,add:add,drop:drop,getAll:getAll,getById:getById,getFavorites:getFavorites}}),app.factory("CoolwayService",function($rootScope,$resource,GLOBAL,DBService){var resource=$resource(GLOBAL.api.url+GLOBAL.api.version+"/coolways",{},{getAll:{method:"GET",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/coolways/"+GLOBAL.api.feast}});return{resource:resource}}),app.factory("DBService",function($q,DB_CONFIG){var self=this;return self.db=null,self.initTables=function(drop){angular.forEach(DB_CONFIG.tables,function(table){var columns=[];drop&&table.erasable&&self.query("DROP TABLE IF EXISTS "+table.name),angular.forEach(table.columns,function(column){columns.push(column.name+" "+column.type)});var query="CREATE TABLE IF NOT EXISTS "+table.name+" ("+columns.join(",")+")";self.query(query)})},self.init=function(drop){window.sqlitePlugin?(self.db=window.openDatabase(DB_CONFIG.name,"1.0",DB_CONFIG.name+" db",2097152),self.initTables(drop)):setTimeout(function(){self.db=window.openDatabase(DB_CONFIG.name,"1.0",DB_CONFIG.name+" db",2097152),self.initTables(drop)},500)},self.query=function(query,bindings){bindings="undefined"!=typeof bindings?bindings:[];var deferred=$q.defer();return null==self.db?(self.init(),setTimeout(function(){self.db.transaction(function(transaction){transaction.executeSql(query,bindings,function(transaction,result){deferred.resolve(result)},function(transaction,error){deferred.reject(error)})})},500)):self.db.transaction(function(transaction){transaction.executeSql(query,bindings,function(transaction,result){deferred.resolve(result)},function(transaction,error){deferred.reject(error)})}),deferred.promise},self.fetchAll=function(result){for(var output=[],i=0;i<result.rows.length;i++)output.push(result.rows.item(i));return output},self.fetch=function(result){return result.rows.item(0)},self}),app.factory("DeviceService",function($rootScope,$resource,GLOBAL,$http,$q,$ionicLoading){var resource=$resource(GLOBAL.api.url+GLOBAL.api.version+"/devices",{},{register:{method:"POST",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/devices/"+GLOBAL.api.feast},unRegister:{method:"DELETE",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/devices/"+GLOBAL.api.feast}});return{resource:resource}}),app.factory("FacebookService",function($rootScope,GLOBAL,$http,$q,$localStorage){function fetchFeed(){var deferred=$q.defer();return $http.get("https://graph.facebook.com/"+GLOBAL.facebook.user_id+"/feed?fields=full_picture,comments,likes,shares,description,from,story,message,name,created_time,link,picture&"+$localStorage.fbAccessToken).success(function(response){deferred.resolve(response)}).error(function(){}),deferred.promise}function getAccessToken(){var deferred=$q.defer();return $http.get("https://graph.facebook.com/oauth/access_token?client_id="+GLOBAL.facebook.client_id+"&client_secret="+GLOBAL.facebook.client_secret+"&grant_type=client_credentials").success(function(response){deferred.resolve(response)}).error(function(){}),deferred.promise}function getProfile(){var deferred=$q.defer();return $http.get("https://graph.facebook.com/"+GLOBAL.facebook.user_id+"?"+$localStorage.fbAccessToken+"&fields=id,name,picture,cover,about,category,website&format=json").success(function(response){deferred.resolve(response)}).error(function(){}),deferred.promise}return{fetchFeed:fetchFeed,getAccessToken:getAccessToken,getProfile:getProfile}}),app.factory("FavoriteService",function($rootScope,$resource,GLOBAL,DBService,UserService){function add(artistId){var sql="INSERT OR IGNORE INTO favorites (artist_id, user_id) VALUES(?,?)",params=[artistId,UserService.getUser().id];return DBService.query(sql,params).then(function(response){return response}).catch(function(error){console.log(error)})}function remove(artistId){var sql="DELETE FROM favorites WHERE artist_id = ? AND user_id = ?",params=[artistId,UserService.getUser().id];return DBService.query(sql,params).then(function(response){return response}).catch(function(error){console.log(error)})}function drop(){return DBService.query("DROP TABLE IF EXISTS favorites").then(function(result){return DBService.fetch(result)})}function getAll(){return DBService.query("SELECT * FROM favorites WHERE user_id ="+UserService.getUser().id).then(function(result){return DBService.fetchAll(result)})}function getArtistById(id){return DBService.query("SELECT * FROM favorites WHERE artist_id = ? AND user_id = ?",[id,UserService.getUser().id]).then(function(result){return result.rows.length>0&&DBService.fetch(result)}).catch(function(error){console.log(error)})}var resource=$resource(GLOBAL.api.url+GLOBAL.api.version+"/favorites",{},{getAll:{method:"GET",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/favorites/:user_id",params:{user_id:"@user_id"}},create:{method:"POST",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/favorites/:user_id",params:{user_id:"@user_id"}},delete:{method:"DELETE",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/favorites/:user_id",params:{user_id:"@user_id"}}});return{resource:resource,add:add,remove:remove,drop:drop,getAll:getAll,getArtistById:getArtistById}}),app.factory("FoodiesService",function($rootScope,$resource,GLOBAL,DBService){var resource=$resource(GLOBAL.api.url+GLOBAL.api.version+"/foodies",{},{getAll:{method:"GET",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/foodies/"+GLOBAL.api.feast}});return{resource:resource}}),app.factory("InstagramService",function($rootScope,$q,$http,GLOBAL){var endPoint="https://api.instagram.com/v1/users/"+GLOBAL.instagram.user_id+"/media/recent/?access_token="+GLOBAL.instagram.token+"&callback=JSON_CALLBACK",items=[],nextUrl=0,NewInsta=0;return{GetFeed:function(){return $http.jsonp(endPoint).then(function(response){return console.info("response instagram",response),items=response.data.data,nextUrl=response.data.pagination.next_url,NewInsta=response.data.pagination.next_max_id,items})},GetNewPhotos:function(){return $http.jsonp(endPoint+"&min_tag_id="+NewInsta).then(function(response){return items=response.data.data,response.data.data.length>0&&(NewInsta=response.data.pagination.next_max_id),items})},GetOldPhotos:function(){if("undefined"!=typeof nextUrl)return $http.jsonp(endPoint+"&max_tag_id="+nextUrl).then(function(response){return response.data.data.length>0&&(nextUrl=response.data.pagination.next_url),items=response.data.data});var deferred=$q.defer();return deferred.resolve([]),deferred.promise}}}),app.factory("MapService",function($rootScope,$resource,GLOBAL,DBService){function add(map){var sql="INSERT OR IGNORE INTO maps (name, image, latitude, longitude) VALUES(?,?,?,?)",params=[map.name,map.image,map.latitude,map.longitude];return DBService.query(sql,params).then(function(response){return response}).catch(function(error){console.log(error)})}function addLocation(location){var sql="INSERT OR IGNORE INTO locations (name, image, detail, latitude, longitude) VALUES(?,?,?,?,?)",params=[location.name,location.detail,location.image,location.latitude,location.longitude];return DBService.query(sql,params).then(function(response){return response}).catch(function(error){console.log(error)})}function drop(){return DBService.query("DROP TABLE IF EXISTS maps").then(function(result){return DBService.fetch(result)})}function getAll(){return DBService.query("SELECT * FROM maps").then(function(result){return DBService.fetchAll(result)})}function getAllLocations(id){return DBService.query("SELECT * FROM locations").then(function(result){return DBService.fetchAll(result)})}var resource=$resource(GLOBAL.api.url+GLOBAL.api.version+"/maps",{},{getAll:{method:"GET",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/maps/"+GLOBAL.api.feast}});return{resource:resource,add:add,addLocation:addLocation,drop:drop,getAll:getAll,getAllLocations:getAllLocations}}),app.factory("MusicService",function($rootScope){function add(track,toPlaylist){var audio=new Audio;audio.id=id,audio.src=track.url,audio.title=track.name,audio.artist=track.artist,audio.addEventListener("play",function(){console.info("music:play",track),$rootScope.$broadcast("music:play",track)}),audio.addEventListener("pause",function(){console.info("music:pause",track),$rootScope.$broadcast("music:pause",track)}),toPlaylist?(audio.addEventListener("ended",function(){console.info("music:next",track),next()}),setCurrentId(0)):(audio.addEventListener("ended",function(){console.info("music:ended",track),$rootScope.$broadcast("music:ended",track)}),setCurrentId(id)),tracks.push(audio),nextId()}function play(id){id>=0?(pause(),tracks[id].play(),setCurrentId(id)):tracks.length>0&&tracks[currentId].play()}function pause(){tracks.length>0&&tracks[currentId].pause()}function clear(){pause(),tracks=[],id=0}function next(){var last=getLastId()-1;setCurrentId(getCurrentId()<last?getCurrentId()+1:0),play()}function nextId(){id+=1}function getLastId(){return id}function getCurrentId(){return currentId}function setCurrentId(id){currentId=id}var tracks=[],id=0,currentId=0;return{add:add,clear:clear,play:play,pause:pause,getLastId:getLastId}}),app.factory("NotificationService",function($rootScope,$resource,GLOBAL,$http,$q,$ionicLoading){var resource=$resource(GLOBAL.api.url+GLOBAL.api.version+"/notifications",{},{getAll:{method:"GET",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/notifications/"+GLOBAL.api.feast}});return{resource:resource}}),app.factory("playerService",function($rootScope,Spotify){var service={};return service.getTopTracks=function(spotifyId,countryIso){Spotify.getArtistTopTracks("4wLXwxDeWQ8mtUIRPxGiD6","ES").then(function(data){$rootScope.$broadcast("top_tracks",data.tracks)})},service.openSpotify=function(link){window.open(link,"_blank","location=yes")},service}),app.factory("PosterService",function($rootScope,$resource,GLOBAL,DBService){function add(poster){var sql="INSERT OR IGNORE INTO posters (id, image) VALUES(?,?)",params=[poster.id,poster.image];return DBService.query(sql,params).then(function(response){return response}).catch(function(error){console.log(error)})}function drop(){return DBService.query("DROP TABLE IF EXISTS posters").then(function(result){return DBService.fetch(result)})}function get(){return DBService.query("SELECT * FROM posters ORDER BY id DESC LIMIT 1").then(function(result){return DBService.fetchAll(result)})}var resource=$resource(GLOBAL.api.url+GLOBAL.api.version+"/posters",{},{getAll:{method:"GET",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/posters/"+GLOBAL.api.feast}});return{resource:resource,add:add,drop:drop,get:get}}),app.factory("ScheduleService",function($rootScope,$resource,GLOBAL,DBService){var resource=$resource(GLOBAL.api.url+GLOBAL.api.version+"/schedules",{},{getAll:{method:"GET",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/schedules/"+GLOBAL.api.feast}});return{resource:resource}}),app.factory("SpotifyService",function($rootScope,Spotify,GLOBAL,$q){function getTopTracks(spotifyId){return Spotify.getArtistTopTracks(spotifyId,GLOBAL.spotify.country_iso).then(function(data){return data.tracks})}function gerPlayList(){return Spotify.getPlaylist(GLOBAL.spotify.user_id,GLOBAL.spotify.playlist_id).then(function(data){return data})}return{getTopTracks:getTopTracks,gerPlayList:gerPlayList}}),app.factory("TimeService",function($rootScope,GLOBAL,$http,$q,$localStorage){return{dhms:function(t){var days,hours,minutes,seconds;days=Math.floor(t/86400),t-=86400*days,hours=Math.floor(t/3600)%24,t-=3600*hours,minutes=Math.floor(t/60)%60,t-=60*minutes,seconds=t%60;if(days>0)var response=[days+" días -",hours+" horas"];else var response=[hours+" horas"];return response.join(" ")}}}),app.factory("TwitterService",function($cordovaOauth,$cordovaOauthUtility,$http,$resource,$q,$localStorage,$twitterApi,GLOBAL){function storeUserToken(data){$localStorage.twAccessToken=JSON.stringify(data)}function getStoredToken(){return $localStorage.twAccessToken}function getTimeLine(){var params={};return params.screen_name=GLOBAL.twitter.screen_name,$twitterApi.getUserTimeline(params).then(function(data){return data},function(error){return error})}return{initialize:function(){var deferred=$q.defer(),token=getStoredToken();return"undefined"==typeof token?$cordovaOauth.twitter(GLOBAL.twitter.client_id,GLOBAL.twitter.client_secret).then(function(response){storeUserToken(response),deferred.resolve(!0),$twitterApi.configure(GLOBAL.twitter.client_id,GLOBAL.twitter.client_secret,response)},function(error){console.info("error",error),deferred.reject(!1)}):($twitterApi.configure(GLOBAL.twitter.client_id,GLOBAL.twitter.client_secret,token),deferred.resolve(!0)),deferred.promise},isAuthenticated:function(){return"undefined"!=typeof getStoredToken()},getTimeLine:getTimeLine}}),app.factory("UserService",function($rootScope,$resource,GLOBAL,$localStorage,$ionicPopup,DeviceService,$q,$state){function isLogged(){return"undefined"!=typeof $localStorage.user&&"undefined"!=typeof $localStorage.user.access_token}function getUser(){return $localStorage.user}function getUserId(){return isLogged()?getUser().id:0}function notificationActive(){return!!isLogged()&&getUser().notification}function setUser(user){$localStorage.user=user,registerNotifications()}function logout(){var data={};data.access_token=$localStorage.user.access_token,data.device_token=$localStorage.device_token,data.os=$localStorage.os,unRegisterDevice(data).then(function(response){$localStorage.user={},$state.go("base.login")})}function validateEmail(email){var pattern=/^([a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+(\.[a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+)*|"((([ \t]*\r\n)?[ \t]+)?([\x01-\x08\x0b\x0c\x0e-\x1f\x7f\x21\x23-\x5b\x5d-\x7e\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|\\[\x01-\x09\x0b\x0c\x0d-\x7f\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))*(([ \t]*\r\n)?[ \t]+)?")@(([a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.)+([a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.?$/i;return pattern.test(email)}function unRegisterDevice(data){var deferred=$q.defer(),deviceResource=new DeviceService.resource;return deviceResource.$unRegister({access_token:data.access_token,device_token:data.device_token},function(response){deferred.resolve(response)},function(error){deferred.resolve(error)}),deferred.promise}function registerDevice(data){var deferred=$q.defer(),deviceResource=new DeviceService.resource;return deviceResource.access_token=data.access_token,deviceResource.device_token=data.device_token,deviceResource.os=data.os,deviceResource.$register(function(response){deferred.resolve(response)},function(error){deferred.resolve(error)}),deferred.promise}function registerNotifications(){if(window.PushNotification){var PushNotification=window.PushNotification,push=PushNotification.init({android:{senderID:"86166158594",icon:"icon",iconColor:"lightgrey"},ios:{alert:"true",badge:"true",sound:"true"}});(null===getUser().device_token||void 0===getUser().device_token&&null!==push)&&push.on("registration",function(data){var os="0";ionic.Platform.isIOS()&&(os="1"),$localStorage.device_token=data.registrationId,$localStorage.os=os,registerDevice({access_token:getUser().access_token,os:os,device_token:data.registrationId})}),push.on("notification",function(data){$ionicPopup.alert({title:data.title,template:data.message})}),push.on("error",function(e){})}}var resource=$resource(GLOBAL.api.url+GLOBAL.api.version+"/users",{},{register:{method:"POST",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/users/"},login:{method:"POST",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/authentications/"},updatePassword:{method:"PUT",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/user/"},recoverPassword:{method:"PUT",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/authentication/"}});return{resource:resource,isLogged:isLogged,validateEmail:validateEmail,getUser:getUser,getUserId:getUserId,setUser:setUser,logout:logout,registerNotifications:registerNotifications,registerDevice:registerDevice,unRegisterDevice:unRegisterDevice,notificationActive:notificationActive}}),app.factory("VersionService",function($rootScope,$resource,GLOBAL,DBService){var resource=$resource(GLOBAL.api.url+GLOBAL.api.version+"/versions",{},{get:{method:"GET",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/versions/"+GLOBAL.api.feast}});return{resource:resource}}),app.factory("WeatherService",function($rootScope,$resource,GLOBAL,DBService){var resource=$resource(GLOBAL.api.url+GLOBAL.api.version+"/weathers",{},{getAll:{method:"GET",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/weathers/"+GLOBAL.api.feast}});return{resource:resource}}),app.controller("accountCtrl",function($scope,$state){$scope.state=$state}),app.controller("ArtistController",function($rootScope,$scope,DBService,$state,$filter,$ionicPopup,$ionicScrollDelegate,filterFilter,$anchorScroll,ArtistService,SpotifyService,ScheduleService,GLOBAL,$ionicActionSheet,$ionicLoading,$stateParams,$cordovaSocialSharing,MusicService,VersionService,$localStorage){if($scope.init=function(){$scope.view={},$scope.view.ready=!1,$scope.view.server_image=GLOBAL.server.image,$scope.view.feast_id=GLOBAL.api.feast,$scope.audio=new Audio,$scope.pause=!0,$scope.view.currentDate=$filter("date")(new Date,"yyyy-MM-dd"),$scope.view.feastDate=$filter("date")(new Date("2016-10-12"),"yyyy-MM-dd"),$scope.view.scheduleActive=!1,ScheduleService.resource.getAll().$promise.then(function(response){$scope.view.scheduleActive=response.data.status})},$scope.init(),$scope.showDetail=function(id){return id>0&&void $state.go("menu.artist-detail",{id:id})},self.getArtists=function(sort){ArtistService.getAll().then(function(artists){artists.length>0?($scope.view.artists=artists,sort===!0&&self.sort(),$scope.view.ready=!0,$scope.$emit("artist:ready",!0)):($ionicLoading.show({content:"Cargando",animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0}),ArtistService.resource.getAll().$promise.then(function(artists){$scope.view.artists=artists.data,sort===!0&&self.sort(),angular.forEach(artists.data,function(value,key){ArtistService.add(value)}),$ionicLoading.hide(),$scope.view.ready=!0,$scope.$emit("artist:ready",!0)},function(error){$ionicLoading.hide(),$scope.view.ready=!0}))})},self.sort=function(){function addLetter(code){var letter=String.fromCharCode(code);artists.push({isLetter:!0,letter:letter}),letters.push(letter)}var currentCharCode=" ".charCodeAt(0)-1;$scope.view.artists.sort(function(a,b){return a.name>b.name?1:-1}).forEach(function(artist){var artistCharCode=artist.name.toUpperCase().charCodeAt(0);artistCharCode<65&&(artistCharCode=35);for(var difference=artistCharCode-currentCharCode,i=1;i<=difference;i++)addLetter(currentCharCode+i);currentCharCode=artistCharCode,artists.push(artist)});for(var i=currentCharCode+1;i<="Z".charCodeAt(0);i++)addLetter(i)},"menu.artist-list"==$state.current.name){var show=!1,last=!1;$scope.lastArtist=function(letter){return 1==letter?(show=!1,last=!1):last?show=!0:last=!0,show};var letters=$scope.letters=[],artists=$scope.artists=[];self.getArtists(!0),$scope.getItemHeight=function(item){return item.isLetter?35:100},$scope.scrollTop=function(){$ionicScrollDelegate.scrollTop()},$scope.scrollBottom=function(){
$ionicScrollDelegate.scrollBottom()};var letterHasMatch={};$scope.getArtistsList=function(){return letterHasMatch={},artists.filter(function(item){var itemDoesMatch=!$scope.view.search||item.isLetter||item.name.toLowerCase().indexOf($scope.view.search.toLowerCase())>-1;if(!item.isLetter&&itemDoesMatch){var letter=item.name.charAt(0).toUpperCase();item.name.charCodeAt(0)<65&&(letter="#"),letterHasMatch[letter]=!0}return itemDoesMatch}).filter(function(item){return!(item.isLetter&&!letterHasMatch[item.letter])})},$scope.clearSearch=function(){$scope.view.search=""}}"menu.artist-discover"==$state.current.name&&($localStorage.lastUpdate!=$scope.view.currentDate?VersionService.resource.get().$promise.then(function(response){if(response.data.version!=$localStorage.version){var confirmPopup=$ionicPopup.confirm({title:"Nueva actualización",template:"¿Desea descargar los nuevos datos?"});confirmPopup.then(function(confirm){confirm?(DBService.init(!0),self.getArtists(!1),$localStorage.version=response.data.version,$localStorage.lastUpdate=$filter("date")(new Date,"yyyy-MM-dd")):(self.getArtists(!1),$localStorage.lastUpdate=$filter("date")(new Date,"yyyy-MM-dd"))})}else self.getArtists(!1)},function(error){self.getArtists(!1)}):self.getArtists(!1),$scope.playTrack=function(artist){$rootScope.$broadcast("music:clear",!0),$scope.view.isPause&&$scope.view.currentTrack.spotify_id==artist.spotify_id?MusicService.play():SpotifyService.getTopTracks(artist.spotify_id).then(function(tracks){var track={};track.spotify_id=artist.spotify_id,track.artist=tracks[0].artists[0].name,track.name=tracks[0].name,track.url=tracks[0].preview_url,MusicService.clear(),MusicService.add(track,!1),MusicService.play()})},$scope.pauseTrack=function(){MusicService.pause()},$scope.$on("music:play",function(event,args){$scope.view.isPlaying=!0,$scope.view.isPause=!1,$scope.view.currentTrack=args}),$scope.$on("music:pause",function(event,args){$scope.view.isPlaying=!1,$scope.view.isPause=!0,$scope.view.currentTrack=args})),"menu.artist-detail"==$state.current.name&&(ArtistService.getById($stateParams.id).then(function(artist){$scope.view.artist=artist,$scope.view.ready=!0}),$scope.playTrack=function(artist){$rootScope.$broadcast("music:clear",!0),$scope.view.isPause&&$scope.view.currentTrack.spotify_id==artist.spotify_id?MusicService.play():SpotifyService.getTopTracks(artist.spotify_id).then(function(tracks){var track={};track.spotify_id=artist.spotify_id,track.artist=tracks[0].artists[0].name,track.name=tracks[0].name,track.url=tracks[0].preview_url,MusicService.clear(),MusicService.add(track,!1),MusicService.play()})},$scope.shareAnywhere=function(artist){var name=artist.name,image=$scope.view.server_image+"artists/"+artist.id+"/cover/"+artist.image_cover;$cordovaSocialSharing.share("Te recomiendo "+name+" en el #InterestelarSevilla","InterEstelar Sevilla",image,"http://www.interestelarsevilla.com/")})}),app.controller("BaseController",function($scope,$state){$scope.init=function(){$scope.state=$state,$scope.view={},$scope.view.navigation=!1,$scope.view.show="sign_in"},$scope.init(),$scope.openLink=function(link){window.open(link,"_system","location=yes")},$scope.login=function(){$scope.view.show="sign_in",$state.go("base.login")},$scope.register=function(){$state.go("base.register"),$scope.view.show="sign_up"}}),app.controller("CoolwayController",function($scope,CoolwayService,GLOBAL,$ionicLoading,$state,$stateParams,$cordovaSocialSharing,$ionicPopup){$scope.loadPhotos=function(){$ionicLoading.show({content:"Cargando",animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0}),CoolwayService.resource.getAll().$promise.then(function(photos){$scope.view.photos=photos.data,$ionicLoading.hide(),$scope.view.ready=!0},function(error){$ionicLoading.hide(),$scope.view.ready=!0,$ionicPopup.alert({title:"Sin conexión a internet"})})},$scope.init=function(){$scope.view={},$scope.view.photos={},$scope.view.server_image=GLOBAL.server.image,$scope.view.feast_id=GLOBAL.api.feast,$scope.loadPhotos()},$scope.init(),$scope.showDetail=function(image){$state.go("menu.coolway-detail",{image:image})},"menu.coolway-detail"==$state.current.name&&($scope.view.image=$stateParams.image),$scope.openPage=function(type,url){var scheme,link;if("BROWSER"==type)window.open(url,"_system","location=yes");else{switch(type){case"FACEBOOK":link="fb://publish/profile/345546062072",scheme=ionic.Platform.isAndroid()?"com.facebook.katana":"fb://";break;case"TWITTER":link="twitter://user?screen_name=coolwayspain",scheme=ionic.Platform.isAndroid()?"com.twitter.android":"twitter://";break;case"INSTAGRAM":link="instagram://user?username=coolway_spain",scheme=ionic.Platform.isAndroid()?"com.instagram.android":"instagram://"}appAvailability.check(scheme,function(){window.open(link,"_system","location=no")},function(){window.open(url,"_system","location=yes")})}},$scope.shareImage=function(image){$cordovaSocialSharing.share(null,null,image,null)}}),app.controller("FavoriteController",function($scope){$scope.init=function(){$scope.view={},$scope.view.scheduleActive=!1},$scope.$on("schedule:change",function(event,args){$scope.view.scheduleActive=args})}),app.controller("FoodiesController",function($rootScope,$scope,DBService,$state,$filter,$ionicPopup,$ionicScrollDelegate,filterFilter,$anchorScroll,FoodiesService,SpotifyService,ScheduleService,GLOBAL,$ionicActionSheet,$ionicLoading,$stateParams,$cordovaSocialSharing,$localStorage){if($scope.init=function(){$scope.view={},$scope.view.ready=!1,$scope.view.server_image=GLOBAL.server.image,$scope.view.feast_id=GLOBAL.api.feast},$scope.init(),$scope.showDetail=function(id){return null!=id&&void $state.go("menu.foodies-detail",{id:id})},self.sort=function(){function addLetter(code){var letter=String.fromCharCode(code);foodies.push({isLetter:!0,letter:letter}),letters.push(letter)}var currentCharCode=" ".charCodeAt(0)-1;$scope.view.foodies.sort(function(a,b){return a.name>b.name?1:-1}).forEach(function(item){var itemCharCode=item.name.toUpperCase().charCodeAt(0);itemCharCode<65&&(itemCharCode=35);for(var difference=itemCharCode-currentCharCode,i=1;i<=difference;i++)addLetter(currentCharCode+i);currentCharCode=itemCharCode,foodies.push(item)});for(var i=currentCharCode+1;i<="Z".charCodeAt(0);i++)addLetter(i)},self.getFoodies=function(sort){$ionicLoading.show({content:"Cargando",animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0}),FoodiesService.resource.getAll().$promise.then(function(foodies){$localStorage.foodies=[],$scope.view.foodies=foodies.data,sort===!0&&self.sort(),angular.forEach(foodies.data,function(value,key){$localStorage.foodies[value.id]=value}),$ionicLoading.hide(),$scope.view.ready=!0},function(error){$ionicLoading.hide(),$scope.view.ready=!0})},"menu.foodies"==$state.current.name){var letters=$scope.letters=[],foodies=[];self.getFoodies(!0),$scope.getItemHeight=function(item){return item.isLetter?35:100},$scope.scrollTop=function(){$ionicScrollDelegate.scrollTop()},$scope.scrollBottom=function(){$ionicScrollDelegate.scrollBottom()};var letterHasMatch={};$scope.getFoodiesList=function(){return letterHasMatch={},foodies.filter(function(item){var itemDoesMatch=!$scope.view.search||item.isLetter||item.name.toLowerCase().indexOf($scope.view.search.toLowerCase())>-1;if(!item.isLetter&&itemDoesMatch){var letter=item.name.charAt(0).toUpperCase();item.name.charCodeAt(0)<65&&(letter="#"),letterHasMatch[letter]=!0}return itemDoesMatch}).filter(function(item){return!(item.isLetter&&!letterHasMatch[item.letter])})},$scope.clearSearch=function(){$scope.view.search=""}}if("menu.foodies-detail"==$state.current.name){var id=$stateParams.id;$scope.view.foodie=$localStorage.foodies[id],$scope.view.ready=!0,$scope.shareAnywhere=function(foodies){var name=foodies.name,image=$scope.view.server_image+"foodies/"+foodies.id+"/cover/"+foodies.image_cover;$cordovaSocialSharing.share("Te recomiendo "+name+" en el #FestivalDeLesArts","Festival de les arts",image,"http://www.festivaldelesarts.com/")}}}),app.controller("InfoController",function($scope,$state){$scope.init=function(){$scope.view={}},$scope.init(),$scope.go=function(state){$state.go(state)}}),app.controller("LoginController",function($scope,$state,$http,$q,$ionicActionSheet,$ionicLoading,GLOBAL,$ionicPopup,$cordovaOauth,UserService){$scope.init=function(){$scope.view={},$scope.view.show="sign_in",$scope.view.show_login="options",$scope.view.user=new UserService.resource,$scope.view.loginEmail=!1},$scope.init(),$scope.later=function(){$state.go("menu.artist-discover")},$scope.toggleLoginEmail=function(){$scope.view.loginEmail=!$scope.view.loginEmail},$scope.login=function(){$scope.view.user.email&&UserService.validateEmail($scope.view.user.email)?$scope.view.user.password?($ionicLoading.show({template:"Iniciando..."}),$scope.view.user.$login(function(response){UserService.setUser(response),$state.go("menu.artist-discover"),$ionicLoading.hide()},function(error){$ionicLoading.hide(),$ionicPopup.alert({title:error.data.message})})):$ionicPopup.alert({title:"Ingrese su contraseña"}):$ionicPopup.alert({title:"Ingrese un email valido"})};var fbLoginSuccess=function(response){if(!response.authResponse)return void fbLoginError("Cannot find the authResponse");var authResponse=response.authResponse;getFacebookProfileInfo(authResponse).then(function(profileInfo){$scope.view.user.email=profileInfo.email,$scope.view.user.name=profileInfo.name,$scope.view.user.social=!0,$scope.view.user.$login(function(response){UserService.setUser(response),$state.go("menu.artist-discover"),$ionicLoading.hide()},function(error){$ionicLoading.hide(),$ionicPopup.alert({title:error.data.message})})},function(fail){console.log("profile info fail",fail)})},fbLoginError=function(error){console.log("fbLoginError",error),$ionicLoading.hide()},getFacebookProfileInfo=function(authResponse){var info=$q.defer();return facebookConnectPlugin.api("/me?fields=email,name&access_token="+authResponse.accessToken,null,function(response){console.log(response),info.resolve(response)},function(response){console.log(response),info.reject(response)}),info.promise};$scope.loginFacebook=function(){facebookConnectPlugin.getLoginStatus(function(success){"connected"===success.status?(console.log("getLoginStatus",success.status),getFacebookProfileInfo(success.authResponse).then(function(profileInfo){$scope.view.user.email=profileInfo.email,$scope.view.user.name=profileInfo.name,$scope.view.user.social=!0,$scope.view.user.$login(function(response){UserService.setUser(response),$state.go("menu.artist-discover"),$ionicLoading.hide()},function(error){$ionicLoading.hide(),$ionicPopup.alert({title:error.data.message})})},function(fail){console.log("profile info fail",fail)})):(console.log("getLoginStatus",success.status),$ionicLoading.show({template:"Iniciando ..."}),facebookConnectPlugin.login(["email","public_profile"],fbLoginSuccess,fbLoginError))})}}),app.controller("MainController",function($scope){$scope.init=function(){$scope.view={}},$scope.init()}),app.controller("MapHowGetController",function($scope,$cordovaGeolocation,$ionicLoading,GLOBAL,MapService,$cordovaDevice,$ionicPopup){self.getMapAndLocations=function(){return MapService.resource.getAll().$promise.then(function(map){return map},function(error){return error})},$scope.init=function(){$scope.server_image=GLOBAL.server.image,$scope.view.ready=!1,$ionicLoading.show({content:"Cargando",animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0}),MapService.getAll().then(function(map){map.length>0?($scope.mapData=map[0],self.loadMap()):self.getMapAndLocations().then(function(map){$scope.mapData=map.data,MapService.add(map.data),self.loadMap()}),$ionicLoading.hide(),$scope.view.ready=!0})},self.loadMap=function(){$scope.mapData.latitude.length>0&&($scope.centroLatlng=new google.maps.LatLng($scope.mapData.latitude,$scope.mapData.longitude));var mapOptions={center:$scope.centroLatlng,scrollwheel:!1,zoom:15,maxZoom:19,streetViewControl:!1,zoomControl:!0,mapTypeId:google.maps.MapTypeId.ROADMAP},map=new google.maps.Map(document.getElementById("map-how-get"),mapOptions);$scope.map=map,$scope.directionsDisplay=new google.maps.DirectionsRenderer({polylineOptions:{strokeColor:"red"}});new google.maps.Marker({position:$scope.centroLatlng,map:$scope.map});$scope.map.setZoom(15),$scope.map.setCenter($scope.centroLatlng)},$scope.goFromMyLocation=function(mode){var posOptions={timeout:1e4,enableHighAccuracy:!0,maximumAge:36e5};$cordovaGeolocation.getCurrentPosition(posOptions).then(function(position){var myLocation=new google.maps.LatLng(position.coords.latitude,position.coords.longitude),directionsService=new google.maps.DirectionsService;$scope.directionsDisplay.setMap($scope.map),directionsService.route({origin:myLocation,destination:$scope.centroLatlng,travelMode:google.maps.TravelMode[mode]},function(response,status){status===google.maps.DirectionsStatus.OK?$scope.directionsDisplay.setDirections(response):$ionicPopup.show({template:'<p style="color:#000;">Desde tu ubicación no se puede realizar el recorrido.</p>',title:"Recorrido no disponible",buttons:[{text:"<b>Aceptar</b>",type:"button-positive"}]})})},function(err){$ionicPopup.show({template:'<p style="color:#000;">Para poder usar tu ubicación debes tener activado tu gps.</p>',title:"Activar GPS",buttons:[{text:"<b>Aceptar</b>",type:"button-positive"}]})})},$scope.init()}),app.controller("MapController",function($scope,$cordovaGeolocation,$ionicLoading,$cordovaDevice,GLOBAL,MapService,$ionicPopup){self.getMapAndLocations=function(){return MapService.resource.getAll().$promise.then(function(map){return map},function(error){return error})},$scope.init=function(){$scope.server_image=GLOBAL.server.image,$scope.view.ready=!1,$scope.mapData={},$ionicLoading.show({content:"Cargando",animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0}),MapService.getAll().then(function(map){map.length>0?($scope.mapData=map[0],MapService.getAllLocations().then(function(locations){locations.length>0?($scope.locations=locations,self.loadMap()):self.getMapAndLocations().then(function(map){$scope.mapData=map.data,$scope.locations=[],MapService.add(map.data);var cont=0;angular.forEach(map.data.locations,function(value,key){MapService.addLocation(value),$scope.locations.push(value),cont+=1}),self.loadMap()})})):self.getMapAndLocations().then(function(map){$scope.mapData=map.data,$scope.locations=[],MapService.add(map.data);var cont=0;angular.forEach(map.data.locations,function(value,key){MapService.addLocation(value),$scope.locations.push(value),cont+=1}),self.loadMap()}),$ionicLoading.hide(),$scope.view.ready=!0})},self.loadMap=function(){var marker,i,imgOver,infoWindow=new google.maps.InfoWindow;$scope.mapData.latitude.length>0&&($scope.centroLatlng=new google.maps.LatLng($scope.mapData.latitude,$scope.mapData.longitude));var mapOptions={center:$scope.centroLatlng,scrollwheel:!1,streetViewControl:!1,zoomControl:!0,zoom:15,maxZoom:17,mapTypeId:google.maps.MapTypeId.ROADMAP},map=new google.maps.Map(document.getElementById("map"),mapOptions);$scope.locations.length>0&&angular.forEach($scope.locations,function(value,key){marker=new google.maps.Marker({position:new google.maps.LatLng(value.latitude,value.longitude),map:map,title:value.name,icon:new google.maps.MarkerImage($scope.server_image+"googlemap/"+value.image),optimized:!1,zIndex:5}),google.maps.event.addListener(marker,"click",function(marker,i){return function(){infoWindow.setContent(value.detail),infoWindow.open(map,marker)}}(marker,i))});var imageBounds={north:36.191429,south:36.184021,east:-5.923691,west:-5.942702},overlayOpts={opacity:1};imgOver=new google.maps.GroundOverlay($scope.server_image+"feast/"+$scope.mapData.image,imageBounds,overlayOpts),imgOver.setMap(map),$scope.map=map,$scope.directionsDisplay=new google.maps.DirectionsRenderer({polylineOptions:{strokeColor:"red"}})},$scope.showMyLocation=function(){var posOptions={timeout:1e4,enableHighAccuracy:!0,maximumAge:36e5};$cordovaGeolocation.getCurrentPosition(posOptions).then(function(position){var mypos=new google.maps.LatLng(position.coords.latitude,position.coords.longitude);new google.maps.Marker({position:mypos,map:$scope.map,icon:"img/map/my-location-icon.png",optimized:!1,zIndex:5});$scope.map.setZoom(16),$scope.map.setCenter(mypos)},function(err){$ionicPopup.show({template:'<p style="color:#000;">Para poder usar tu ubicación debes tener activado tu gps.</p>',title:"Activar GPS",buttons:[{text:"<b>Aceptar</b>",type:"button-positive"}]})})},$scope.init()}),app.controller("MenuController",function($rootScope,$scope,$ionicModal,ScheduleService,$ionicPopup,$ionicPlatform,DBService,$state,GLOBAL,Spotify,UserService,$ionicLoading,FavoriteService,ArtistService,NotificationService,WeatherService,$cordovaSocialSharing,$filter,DeviceService,$localStorage,$ionicActionSheet){$scope.init=function(){$scope.view={},$scope.view.server_image=GLOBAL.server.image,$scope.view.show_list="favorites",$scope.view.favorites=!1,$scope.view.notifications=!1,$scope.view.pass=new UserService.resource,$scope.view.weathers={},UserService.isLogged()&&($scope.view.user=UserService.getUser(),$scope.view.notificationActive=UserService.notificationActive()),$scope.view.scheduleActive=!1,ScheduleService.resource.getAll().$promise.then(function(response){$scope.view.scheduleActive=response.data.status,$rootScope.$broadcast("schedule:change",response.data.status)})},$scope.init(),$scope.$on("favorite:change",function(event,args){UserService.isLogged()&&self.getFavorites()}),$scope.$on("artist:ready",function(event,args){UserService.isLogged()&&(self.getFavorites(),self.getNotifications())}),self.getFavorites=function(){FavoriteService.getAll().then(function(favorites){if(favorites.length>0){var ids=[];angular.forEach(favorites,function(value,key){ids.push(value.artist_id)}),ArtistService.getFavorites(ids).then(function(favorites){$scope.view.favorites=favorites,$scope.view.ready=!0})}else FavoriteService.resource.getAll({user_id:UserService.getUserId()}).$promise.then(function(favorites){if(favorites.data.length>0){var ids=[];angular.forEach(favorites.data,function(value,key){FavoriteService.add(value.id),ids.push(value.id)}),ArtistService.getFavorites(ids).then(function(favorites){$scope.view.favorites=favorites,$scope.view.ready=!0})}else $scope.view.favorites={},$scope.view.ready=!0},function(error){$scope.view.ready=!0})})},self.getNotifications=function(){NotificationService.resource.getAll().$promise.then(function(notifications){notifications.data.length>0?$scope.view.notifications=notifications.data:($scope.view.notifications={},$scope.view.ready=!0)},function(error){$scope.view.ready=!0})},$ionicModal.fromTemplateUrl("templates/user/settings.html",{scope:$scope}).then(function(modal){$scope.modalSettings=modal}),$scope.openSettings=function(){if(UserService.isLogged())$scope.modalSettings.show();else{var confirmPopup=$ionicPopup.confirm({title:"Iniciar sesión",template:"Para ingresar debes estar logeado"});confirmPopup.then(function(response){response&&$state.go("base.login")})}},$scope.closeSettings=function(){$scope.modalSettings.hide()},$scope.changePassword=function(){$scope.view.pass.current_password?$scope.view.pass.new_password?$scope.view.pass.new_password==$scope.view.confirm?$ionicPopup.alert({title:"Las contraseñas deben ser iguales"}):$scope.view.pass.current_password.length<8||$scope.view.pass.new_password.length<8||$scope.view.pass.confirm.length<8?$ionicPopup.alert({title:"Las contraseña debe tener al menos 8 caracteres"}):($ionicLoading.show({template:"Actualizando..."}),$scope.view.pass.email=UserService.getUser().email,$scope.view.pass.$updatePassword(function(response){UserService.setUser(response),$ionicLoading.hide()},function(error){$ionicLoading.hide(),$ionicPopup.alert({title:error.data.message})})):$ionicPopup.alert({title:"Ingrese su nueva contraseña"}):$ionicPopup.alert({title:"Ingrese su contraseña actual"})},$scope.logout=function(){$ionicLoading.show({template:"Cerrando..."}),UserService.logout(),$scope.closeSettings(),$ionicLoading.hide()},$scope.openLink=function(link){window.open(link,"_system","location=yes")},$scope.showArtistDetail=function(id){return id>0&&void $state.go("menu.artist-detail",{id:id})},$scope.shareFavorites=function(){var message="";angular.forEach($scope.view.favorites,function(value,key){message+=" \r\n"+$filter("cleanName")(value.name)+" \r\n"+$filter("parseDate")(value.schedule)+" - "+$filter("parseDate")(value.schedule,"HH:mm")+"\r\n"+value.stage_name+" \r\n"}),$cordovaSocialSharing.share("Mis artistas favoritos  en el #InterestelarSevilla \r\n"+message,"InterEstelar Sevilla","","\r\n http://www.interestelarsevilla.com/")},$scope.getWeather=function(){$scope.view.weathers&&WeatherService.resource.getAll().$promise.then(function(weathers){$scope.view.weathers=weathers.data})},$scope.changeNotification=function(){var data={};data.access_token=UserService.getUser().access_token,data.device_token=$localStorage.device_token,data.os=$localStorage.os,$scope.view.notificationActive?UserService.registerDevice(data).then(function(response){$localStorage.user.notification=!0}):UserService.unRegisterDevice(data).then(function(response){$localStorage.user.notification=!1})},$scope.getImage=function(url,type){return window.Connection&&navigator.connection.type==Connection.NONE&&(url="img/src/"+type+".png"),url}}),app.controller("notificationController",function($scope){$scope.init=function(){$scope.view={}}}),app.controller("PlayerController",function($scope,$ionicModal,$cordovaOauth,$localStorage,Spotify,SpotifyService,$ionicLoading,GLOBAL,MusicService){$scope.init=function(){$scope.view={},$scope.view.playslist=[]},$scope.init(),$scope.performLogin=function(){$cordovaOauth.spotify(GLOBAL.spotify.client_id,["user-read-private","playlist-read-private"]).then(function(result){$localStorage.spotify_token=result.access_token,Spotify.setAuthToken(result.access_token),$scope.updateInfo()},function(error){})},$scope.loadPlayList=function(){$ionicLoading.show({content:"Cargando",animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0}),SpotifyService.gerPlayList().then(function(data){data.tracks.items.length>0&&($scope.view.playslist=data.tracks.items,MusicService.clear(),angular.forEach(data.tracks.items,function(value,key){var track={};track.spotify_id=value.track.id,track.artist=value.track.artists[0].name,track.name=value.track.name,track.url=value.track.preview_url,MusicService.add(track,!0)}),MusicService.play(),$scope.modal.show(),$ionicLoading.hide())})},$scope.updateInfo=function(){Spotify.getCurrentUser().then(function(data){$scope.loadPlayList()},function(error){$scope.performLogin()})},$ionicModal.fromTemplateUrl("templates/player/main.html",{scope:$scope}).then(function(modal){$scope.modal=modal}),$scope.openPlayList=function(){var storedToken=$localStorage.spotify_token;null!==storedToken?(Spotify.setAuthToken(storedToken),$scope.updateInfo()):$scope.performLogin()},$scope.openPlaylistModal=function(){$scope.modal.show()},$scope.closePlayer=function(){$scope.modal.hide()},$scope.playTrack=function(id){MusicService.play(id)},$scope.pauseTrack=function(){MusicService.pause()},$scope.$on("music:play",function(event,args){$scope.view.isPlaying=!0,$scope.view.isPause=!1,$scope.view.currentTrack=args}),$scope.$on("music:pause",function(event,args){$scope.view.isPlaying=!1,$scope.view.isPause=!0,$scope.view.currentTrack=args}),$scope.$on("music:clear",function(event,args){$scope.view.playslist=[]})}),app.controller("PlaylistsCtrl",function($scope){$scope.playlists=[{title:"Reggae",id:1},{title:"Chill",id:2},{title:"Dubstep",id:3},{title:"Indie",id:4},{title:"Rap",id:5},{title:"Cowbell",id:6}]}).controller("PlaylistCtrl",function($scope,$stateParams){}),app.controller("PosterController",function($scope,$cordovaGeolocation,$ionicLoading,GLOBAL,PosterService){$scope.init=function(){$scope.view.server_image=GLOBAL.server.image,$scope.view.feast=GLOBAL.api.feast,$scope.view.ready=!1,$ionicLoading.show({content:"Cargando",animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0}),PosterService.get().then(function(poster){poster.length>0?(console.info("database",poster),$scope.view.poster=poster[0],$ionicLoading.hide(),$scope.view.ready=!0):PosterService.resource.getAll().$promise.then(function(poster){$scope.view.poster=poster.data,PosterService.add(poster.data),$ionicLoading.hide(),$scope.view.ready=!0},function(error){$ionicLoading.hide(),$scope.view.ready=!0})})},$scope.init()}),app.controller("RecoverController",function($scope,$state,$ionicLoading,$ionicPopup,UserService){$scope.init=function(){$scope.view={},$scope.view.user=new UserService.resource},$scope.init(),$scope.recoverPassword=function(){$scope.view.user.email&&UserService.validateEmail($scope.view.user.email)?($ionicLoading.show({template:"Recuperando contraseña..."}),$scope.view.user.$recoverPassword(function(response){$ionicPopup.alert({title:"La nueva contraseña ha sido enviada a su email"}),$state.go("base.login"),$ionicLoading.hide()},function(error){$ionicLoading.hide(),$ionicPopup.alert({title:error.data.message})})):$ionicPopup.alert({title:"Ingrese un email valido"})}}),app.controller("RegisterController",function($scope,$state,$ionicLoading,$ionicPopup,UserService){$scope.init=function(){$scope.view={},$scope.view.show="sign_up",$scope.view.show_login="options",$scope.view.user=new UserService.resource,$scope.view.loginEmail=!1},$scope.init(),$scope.signUp=function(){$scope.view.user.name?$scope.view.user.email&&UserService.validateEmail($scope.view.user.email)?$scope.view.user.password?$scope.view.user.password.length<8?$ionicPopup.alert({title:"Las contraseña debe tener al menos 8 caracteres"}):($ionicLoading.show({template:"Registrando Cuenta ..."}),$scope.view.user.$register(function(response){UserService.setUser(response),$state.go("menu.artist-discover"),$ionicLoading.hide()},function(error){$ionicLoading.hide(),$ionicPopup.alert({title:error.data.message})})):$ionicPopup.alert({title:"Ingrese su contraseña"}):$ionicPopup.alert({title:"Ingrese un email valido"}):$ionicPopup.alert({title:"Ingrese su nombre"})}}),app.controller("ScheduleController",function($scope,ArtistService,ScheduleService,$ionicLoading,GLOBAL,$state,$filter){$scope.init=function(){$scope.view={},$scope.view.ready=!1,$scope.view.show_list="time",$scope.view.show_day=21,$scope.view.show_day_from="2016-10-21 00:00",$scope.view.show_day_to="2016-10-22 08:00",$scope.view.server_image=GLOBAL.server.image,$scope.view.scheduleActive=!1,$ionicLoading.show({content:"Cargando",animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0}),ScheduleService.resource.getAll().$promise.then(function(response){$scope.view.scheduleActive=response.data.status,$scope.view.ready=!0,$ionicLoading.hide()},function(error){$scope.view.ready=!0,$ionicLoading.hide()})},$scope.init(),$scope.setDay=function(day,from,to){$scope.view.show_day=day,$scope.view.show_day_from=from,$scope.view.show_day_to=to},$scope.validateDate=function(date){return date>$scope.view.show_day_from&&$scope.view.show_day_to>date},$scope.validateStage=function(artists){var valid=!1;return angular.forEach(artists,function(value,key){0==valid&&$scope.validateDate(value.schedule)&&(valid=!0)}),valid},$scope.showDetail=function(id){return id>0&&void $state.go("menu.artist-detail",{id:id})},self.getArtists=function(){ArtistService.getAll().then(function(artists){artists.length>0?$scope.view.artists=artists:($ionicLoading.show({content:"Cargando",animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0}),ArtistService.resource.getAll().$promise.then(function(artists){$scope.view.artists=artists.data,angular.forEach(artists.data,function(value,key){ArtistService.add(value)}),$ionicLoading.hide()},function(error){$ionicLoading.hide()}))})},self.getArtists()}),app.controller("sidebarController",function($scope,$state){$scope.state=$state,$scope.view={},$scope.view.navigation=!1}),app.controller("SocialController",function($scope,FacebookService,InstagramService,TwitterService,$localStorage,$ionicLoading,$ionicPopup){$scope.init=function(){$scope.view={},$scope.view.pics=[],$scope.newItemsIT=[],$scope.noMoreItemsAvailableIT=!1,$scope.have=[],$scope.view.orderBy="-likes.count",$scope.view.show="facebook"},$scope.init(),self.chunk=function(arr,size){for(var newArr=[],i=0;i<arr.length;i+=size)newArr.push(arr.slice(i,i+size));return newArr},$scope.correctTimestring=function(string){return new Date(Date.parse(string))},$scope.showTimeLine=function(){TwitterService.getTimeLine().then(function(data){$scope.view.twTimeline=data},function(error){})},$scope.doRefresh=function(){$scope.showTimeLine(),$scope.$broadcast("scroll.refreshComplete")},$scope.loadTwitter=function(){$scope.view.show="twitter",TwitterService.isAuthenticated()?$scope.showTimeLine():TwitterService.initialize().then(function(result){result===!0&&$scope.showTimeLine()})},$scope.getData=function(){$ionicLoading.show({content:"Cargando",animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0}),$localStorage.hasOwnProperty("fbAccessToken")===!0?(FacebookService.fetchFeed().then(function(response){$scope.view.facebookFeed=response.data,$ionicLoading.hide()}),FacebookService.getProfile().then(function(response){$scope.view.facebookProfile=response})):FacebookService.getAccessToken().then(function(data){$localStorage.fbAccessToken=data,FacebookService.fetchFeed().then(function(response){$scope.view.facebookFeed=response.data,$ionicLoading.hide()})})},$scope.getData(),$scope.doRefreshInstagram=function(){$scope.newItems.length>0?($scope.view.pics=$scope.newItems.concat($scope.view.pics),$scope.$broadcast("scroll.refreshComplete"),$scope.newItems=[]):InstagramService.GetNewPhotos().then(function(items){$scope.view.pics=items.concat($scope.view.pics),$scope.$broadcast("scroll.refreshComplete")})},$scope.LoadMoreInstagram=function(){InstagramService.GetOldPhotos().then(function(items){$scope.view.pics=$scope.view.pics.concat(items),$scope.$broadcast("scroll.infiniteScrollComplete"),0===items.length&&($scope.noMoreItemsAvailableIT=!0)})}}),app.controller("TicketController",function($scope){$scope.init=function(){},$scope.init()}),app.directive("countdown",["TimeService","$interval",function(TimeService,$interval){return{restrict:"A",scope:{date:"@"},link:function(scope,element){var future;future=new Date(scope.date),$interval(function(){var diff;return diff=Math.floor((future.getTime()-(new Date).getTime())/1e3),element.text(TimeService.dhms(diff))},1e3)}}}]),app.directive("errSrc",function(){return{link:function(scope,element,attrs){element.bind("error",function(){attrs.src!=attrs.errSrc&&attrs.$set("src",attrs.errSrc)}),attrs.$observe("ngSrc",function(value){!value&&attrs.errSrc&&attrs.$set("src",attrs.errSrc)})}}}),app.directive("favorite",["FavoriteService","UserService","$ionicPopup","$state",function(FavoriteService,UserService,$ionicPopup,$state){return{restrict:"AE",replace:!0,template:'<button data-ng-click="change(data.status)" class="button button-clear favorite"><img ng-src="img/favorite/{{data.status}}.png"> </button>',scope:{artist:"="},link:function($scope,elem,attrs){function remove(artistId){var FavResource=new FavoriteService.resource;FavResource.$delete({user_id:UserService.getUserId(),artist_id:artistId},function(response){FavoriteService.remove(artistId),$scope.data.status="off",$scope.$emit("favorite:change",!0)},function(error){$ionicPopup.alert({title:"Error",template:"Sin conexión a internet"})})}function add(artistId){var FavResource=new FavoriteService.resource;FavResource.artist_id=artistId,FavResource.$create({user_id:UserService.getUserId()},function(response){FavoriteService.add(artistId),$scope.data.status="on",$scope.$emit("favorite:change",!0)},function(error){$ionicPopup.alert({title:"Error",template:"Sin conexión a internet"})})}$scope.data={artist:$scope.artist},UserService.isLogged()?"undefined"!=typeof $scope.data.artist&&FavoriteService.getArtistById($scope.data.artist.id).then(function(response){
"undefined"==typeof response.artist_id?$scope.data.status="off":$scope.data.status="on"}):$scope.data.status="off",$scope.change=function(status){if(UserService.isLogged())"on"==status?remove($scope.data.artist.id):add($scope.data.artist.id);else{var confirmPopup=$ionicPopup.confirm({title:"Iniciar sesión",template:"Para agregar favoritos debes estar logeado"});confirmPopup.then(function(response){response&&$state.go("base.login")})}}}}}]),app.directive("lazyLoad",["$window","$q",function($window,$q){function load_script(){var s=document.createElement("script");s.src="/www.ticketea.com/entradas-festival-les-arts-2016/buy?width=600px&height=600px",document.body.appendChild(s)}function lazyLoadApi(key){var deferred=$q.defer();return $window.initialize=function(){deferred.resolve()},$window.attachEvent?$window.attachEvent("onload",load_script):$window.addEventListener("load",load_script,!1),deferred.promise}return{restrict:"E",link:function(scope,element,attrs){$window.google&&$window.google.maps||lazyLoadApi().then(function(){$window.google&&$window.google.maps?console.log("gmaps loaded"):console.log("gmaps not loaded")},function(){console.log("promise rejected")})}}}]),app.filter("cleanName",function(){return function(text){return"undefined"==typeof text?text:text.replace("!","")}}),app.filter("parseDate",function($filter,amMoment){return function(text,type){if("undefined"==typeof text)return text;var dt=text.split(/\-|\s/),dateString=dt.slice(0,3).join("-")+" "+dt[3];return $filter("amDateFormat")(dateString,type,null,"Europe/Madrid")}});