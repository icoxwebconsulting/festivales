var app=angular.module("festival",["ionic","ngCordova","ngCordovaOauth","ngStorage","ngResource","spotify"]);app.run(function($rootScope,$state,$stateParams,$ionicPlatform,$cordovaSplashscreen,$state,DBService){$ionicPlatform.ready(function(){DBService.init(),window.cordova&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleDefault()})}),app.config(function($stateProvider,$urlRouterProvider,$ionicConfigProvider){$ionicConfigProvider.backButton.text("").icon("ion-chevron-left"),$stateProvider.state("base",{url:"/","abstract":!0,templateUrl:"templates/base.html",controller:"BaseController"}).state("base.login",{url:"login",views:{content:{templateUrl:"templates/user/sign_in.html",controller:"LoginController"}}}).state("base.register",{url:"register",views:{content:{templateUrl:"templates/user/sign_up.html",controller:"RegisterController"}}}).state("menu",{url:"/app/","abstract":!0,templateUrl:"templates/menu/main.html",controller:"MenuController"}).state("menu.artist-discover",{url:"artist/discover",views:{content:{templateUrl:"templates/artist/main.html",controller:"ArtistController"}}}).state("menu.artist-list",{url:"artist",views:{content:{templateUrl:"templates/artist/list.html",controller:"ArtistController"}}}).state("menu.artist-detail",{url:"artist/:id",views:{content:{templateUrl:"templates/artist/detail.html",controller:"ArtistController"}}}).state("menu.poster",{url:"poster",views:{content:{templateUrl:"templates/poster/main.html"}}}).state("menu.schedule",{url:"schedule",views:{content:{templateUrl:"templates/schedule/main.html",controller:"ScheduleController"}}}).state("menu.map",{url:"map",views:{content:{templateUrl:"templates/map/main.html"}}}).state("menu.ticket",{url:"ticket",views:{content:{templateUrl:"templates/ticket/main.html",controller:"TicketController"}}}).state("menu.coolway",{url:"coolway",views:{content:{templateUrl:"templates/coolway/main.html",controller:"CoolwayController"}}}).state("menu.streaming",{url:"streaming",views:{content:{templateUrl:"templates/streaming/main.html",controller:"StreamingController"}}}).state("menu.info",{url:"info",views:{content:{templateUrl:"templates/info/main.html",controller:"InfoController"}}}).state("menu.organizer",{url:"organizer",views:{content:{templateUrl:"templates/info/organizer.html"}}}).state("menu.social",{url:"social",views:{content:{templateUrl:"templates/social/main.html",controller:"SocialController"}}}),$urlRouterProvider.otherwise("/login"),$ionicConfigProvider.views.maxCache(0)}),app.constant("DB_CONFIG",{name:"DB",tables:[{name:"artists",columns:[{name:"id",type:"integer"},{name:"name",type:"text"},{name:"description",type:"text"},{name:"image_profile",type:"text"},{name:"image_cover",type:"text"},{name:"stage_id",type:"text"},{name:"stage_name",type:"text"},{name:"schedule",type:"text"},{name:"spotify_id",type:"text"},{name:"facebook",type:"text"},{name:"twitter",type:"text"},{name:"instagram",type:"text"}]}]}),app.constant("GLOBAL",{api:{url:"http://coolway.dev/app_dev.php/api/",version:"v1",feast:1},server:{image:"http://coolway.dev/uploads/"},spotify:{country_iso:"ES",client_id:"1706543149628857"},facebook:{api_version:"v2.5",user_id:"850431581647988",client_id:"1706543149628857",client_secret:"99a5617adda2ef35f914ab9f01dbc626"},instagram:{user_id:"1545629618",client_id:"642176ece1e7445e99244cec26f4de1f"}}),app.directive("countdown",["TimeService","$interval",function(TimeService,$interval){return{restrict:"A",scope:{date:"@"},link:function(scope,element){var future;future=new Date(scope.date),$interval(function(){var diff;return diff=Math.floor((future.getTime()-(new Date).getTime())/1e3),element.text(TimeService.dhms(diff))},1e3)}}}]),app.directive("lazyLoad",["$window","$q",function($window,$q){function load_script(){var s=document.createElement("script");s.src="/www.ticketea.com/entradas-festival-les-arts-2016/buy?width=600px&height=600px",document.body.appendChild(s)}function lazyLoadApi(key){var deferred=$q.defer();return $window.initialize=function(){deferred.resolve()},$window.attachEvent?$window.attachEvent("onload",load_script):$window.addEventListener("load",load_script,!1),deferred.promise}return{restrict:"E",link:function(scope,element,attrs){$window.google&&$window.google.maps?console.log("gmaps already loaded"):lazyLoadApi().then(function(){console.log("promise resolved"),$window.google&&$window.google.maps?console.log("gmaps loaded"):console.log("gmaps not loaded")},function(){console.log("promise rejected")})}}}]),app.controller("accountCtrl",function($scope,$state){$scope.state=$state}),app.controller("ArtistController",function($scope,$state,$ionicScrollDelegate,filterFilter,$location,$anchorScroll,$ionicModal,ArtistService,GLOBAL,$ionicLoading,$stateParams){if($scope.init=function(){$scope.view={},$scope.view.server_image=GLOBAL.server.image},$scope.init(),$scope.showDetail=function(id){return id>0?void $state.go("menu.artist-detail",{id:id}):!1},self.getArtists=function(sort){$scope.view.ready=!1,$ionicLoading.show({content:"Cargando",animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0}),ArtistService.getAll().then(function(artists){artists.length>0?(console.info("database",artists),$scope.view.artists=artists,sort===!0&&self.sort(),$ionicLoading.hide(),$scope.view.ready=!0):ArtistService.resource.getAll().$promise.then(function(artists){console.info("api",artists),$scope.view.artists=artists.data,sort===!0&&self.sort(),angular.forEach(artists.data,function(value,key){ArtistService.add(value)}),$ionicLoading.hide(),$scope.view.ready=!0})})},self.sort=function(){function addLetter(code){var letter=String.fromCharCode(code);artists.push({isLetter:!0,letter:letter}),letters.push(letter)}var currentCharCode=" ".charCodeAt(0)-1;$scope.view.artists.sort(function(a,b){return a.name>b.name?1:-1}).forEach(function(artist){var artistCharCode=artist.name.toUpperCase().charCodeAt(0);65>artistCharCode&&(artistCharCode=35);for(var difference=artistCharCode-currentCharCode,i=1;difference>=i;i++)addLetter(currentCharCode+i);currentCharCode=artistCharCode,artists.push(artist)});for(var i=currentCharCode+1;i<="Z".charCodeAt(0);i++)addLetter(i)},"menu.artist-list"==$state.current.name){var letters=$scope.letters=[],artists=$scope.artists=[];self.getArtists(!0),$scope.getItemHeight=function(item){return item.isLetter?40:100},$scope.scrollTop=function(){$ionicScrollDelegate.scrollTop()},$scope.scrollBottom=function(){$ionicScrollDelegate.scrollBottom()};var letterHasMatch={};$scope.getArtists=function(){return letterHasMatch={},artists.filter(function(item){var itemDoesMatch=!$scope.view.search||item.isLetter||item.name.toLowerCase().indexOf($scope.view.search.toLowerCase())>-1;if(!item.isLetter&&itemDoesMatch){var letter=item.name.charAt(0).toUpperCase();item.name.charCodeAt(0)<65&&(letter="#"),letterHasMatch[letter]=!0}return itemDoesMatch}).filter(function(item){return item.isLetter&&!letterHasMatch[item.letter]?!1:!0})},$scope.clearSearch=function(){$scope.view.search=""}}"menu.artist-discover"==$state.current.name&&self.getArtists(!1),"menu.artist-detail"==$state.current.name&&ArtistService.getById($stateParams.id).then(function(artist){$scope.view.artist=artist})}).filter("parseName",function(){return function(text){return"undefined"==typeof text?text:text.replace("!","")}}),app.controller("BaseController",function($scope,$state){$scope.init=function(){$scope.state=$state,$scope.view={},$scope.view.navigation=!1,$scope.view.show="sign_in"},$scope.init(),$scope.login=function(){$scope.view.show="sign_in",$state.go("base.login")},$scope.register=function(){$state.go("base.register"),$scope.view.show="sign_up"}}),app.controller("CoolwayController",function($scope,$cordovaAppAvailability){$scope.init=function(){$scope.view={}},$scope.init(),$scope.openPage=function(type,url){var scheme,link;if("BROWSER"==type)window.open(url,"_system","location=yes");else{switch(type){case"FACEBOOK":link="fb://profile/CoolwaySpain",scheme=ionic.Platform.isAndroid()?"com.facebook.katana":"fb://";break;case"TWITTER":link="twitter://user?screen_name=coolwayspain",scheme=ionic.Platform.isAndroid()?"com.twitter.android":"twitter://";break;case"INSTAGRAM":link="instagram://user?username=coolway_spain",scheme=ionic.Platform.isAndroid()?"com.instagram.android":"instagram://"}appAvailability.check(scheme,function(){window.open(link,"_system","location=no"),console.log("Twitter is available")},function(){window.open(url,"_system","location=yes"),console.log("Twitter is not available")})}}}),app.controller("FavoriteController",function($scope){$scope.init=function(){$scope.view={}}}),app.controller("InfoController",function($scope,$state){$scope.init=function(){$scope.view={}},$scope.init(),$scope.go=function(state){$state.go(state)}}),app.controller("LoginController",function($scope,$state,$http,$ionicLoading,$ionicPopup,$cordovaOauth){$scope.init=function(){$scope.view={},$scope.view.show="sign_in",$scope.view.show_login="options",$scope.data={},$scope.error=!1,$scope.view.loginEmail=!1},$scope.init(),$scope.later=function(){$state.go("menu.artist-discover")},$scope.loginFacebook=function(){$cordovaOauth.facebook("1671907443037216",["email"]).then(function(result){$ionicLoading.show({template:"Verificando ..."})})},$scope.loginGoogle=function(){$cordovaOauth.google("140186210091-bp9lgae3g52hvmro7gse1q2t20gba32v.apps.googleusercontent.com",["email"]).then(function(result){$ionicLoading.show({template:"Verificando ..."})})},$scope.toggleLoginEmail=function(){$scope.view.loginEmail=!$scope.view.loginEmail},$scope.login=function(){$scope.error=!1,$scope.data.email?$scope.data.password?$ionicLoading.show({template:"Verificando ..."}):$ionicPopup.alert({title:"Ingrese su Contraseña"}):$ionicPopup.alert({title:"Ingrese su E-mail"})}}),app.controller("MainController",function($scope,$timeout,playerService){$scope.init=function(){$scope.audio=new Audio,$scope.view={}},$scope.init(),self.chunk=function(arr,size){for(var newArr=[],i=0;i<arr.length;i+=size)newArr.push(arr.slice(i,i+size));return console.info("return",newArr),newArr},$scope.$on("top_tracks",function(evt,data){$scope.view.tracks=self.chunk(data,2)}),$scope.playTrack=function(spotifyId){$scope.audio.src=track.preview_url,$scope.audio.play()},$scope.play=function(){$scope.audio.src&&$scope.audio.play()},$scope.stop=function(){$scope.audio.src&&$scope.audio.pause()}}),app.controller("MenuController",function($scope,$ionicModal,Spotify,$cordovaInAppBrowser){$scope.init=function(){$scope.view={},$scope.view.show_list="favorites",$scope.view.favorites=!1,$scope.view.notifications=!1,$scope.view.setting={},$scope.view.setting.notifications=!0},$scope.init(),$ionicModal.fromTemplateUrl("templates/user/settings.html",{scope:$scope}).then(function(modal){$scope.modalSettings=modal}),$scope.openSettings=function(){$scope.modalSettings.show()},$scope.closeSettings=function(){$scope.modalSettings.hide()},$scope.login=function(){Spotify.login().then(function(data){console.log(data),alert("You are now logged in")},function(){console.log("didn't log in")})}}),app.controller("notificationController",function($scope){$scope.init=function(){$scope.view={}}}),app.controller("PlayerController",function($scope,$state,$ionicModal,$ionicPlatform,$cordovaOauth,$localStorage,Spotify){$scope.performLogin=function(){$cordovaOauth.spotify($scope.clientId,["user-read-private","playlist-read-private"]).then(function(result){$localStorage.spotify_token=result.access_token,Spotify.setAuthToken(result.access_token),$scope.updateInfo()},function(error){console.log("Error -> "+error)})},$scope.stop=function(){$scope.audio.src&&$scope.audio.pause()},$scope.play=function(){$scope.audio.src&&$scope.audio.play()},$ionicModal.fromTemplateUrl("templates/player/main.html",{scope:$scope}).then(function(modal){$scope.modal=modal}),$scope.openPlayer=function(){var storedToken=$localStorage.spotify_token;null!==storedToken?(Spotify.setAuthToken(storedToken),$scope.updateInfo()):$scope.performLogin()},$scope.closePlayer=function(){$scope.modal.hide()},$scope.updateInfo=function(){Spotify.getCurrentUser().then(function(data){$scope.getUserPlaylists(data.id)},function(error){$scope.performLogin()})},$scope.getUserPlayLists=function(userId){Spotify.getUserPlaylists(userId).then(function(data){$scope.playlists=data.items})},$scope.init=function(){$scope.state=$state,$scope.view={},$scope.clientId="77b0545674984c768ed449759d5911c8",$scope.playlists=[]},$scope.init()}),app.controller("RegisterController",function($scope,$state,$ionicLoading,$ionicPopup){$scope.init=function(){$scope.view={},$scope.view.show="sign_up",$scope.view.show_login="options",$scope.data={},$scope.error=!1,$scope.view.loginEmail=!1},$scope.init(),$scope.data={privacy_police:!1},$scope.error=!1,$scope.signUp=function(){$scope.error=!1,$scope.data.email?$scope.data.password?$scope.data.password!==$scope.data.repassword?$ionicPopup.alert({title:"Confirme su Contraseña"}):$ionicLoading.show({template:"Creando Cuenta ..."}):$ionicPopup.alert({title:"Ingrese su Contraseña"}):$ionicPopup.alert({title:"Ingrese su E-mail"})}}),app.controller("ScheduleController",function($scope){$scope.init=function(){$scope.view={},$scope.view.show_list="time"},$scope.init()}),app.controller("SocialController",function($scope,FacebookService,InstagramService,$localStorage){$scope.init=function(){$scope.view={},$scope.view.pics=[],$scope.have=[],$scope.view.orderBy="-likes.count",$scope.view.show="instagram"},$scope.init(),self.chunk=function(arr,size){for(var newArr=[],i=0;i<arr.length;i+=size)newArr.push(arr.slice(i,i+size));return console.info("return",newArr),newArr},$scope.getData=function(){InstagramService.fetchImages(function(data){console.info("instagram",data);for(var i=0;i<data.length;i++)"undefined"==typeof $scope.have[data[i].id]&&($scope.view.pics.push(data[i]),$scope.have[data[i].id]="1")}),$localStorage.hasOwnProperty("accessToken")===!0?(FacebookService.fetchFeed().then(function(response){$scope.view.facebookFeed=response.data,console.info("facebook",$scope.view.facebookFeed)}),FacebookService.getProfilePicture().then(function(response){$scope.view.facebookPicture=response})):FacebookService.getAccessToken().then(function(data){$localStorage.accessToken=data,service.fetchFeed()})},$scope.getData()}),app.controller("StreamingController",function($scope){$scope.init=function(){$scope.view={}}}),app.controller("TicketController",function($scope){$scope.init=function(){$scope.view={}}}),app.factory("ArtistService",function($rootScope,$resource,GLOBAL,DBService){function add(artist){var sql="INSERT OR IGNORE INTO artists (id, name, description, image_profile, image_cover, stage_id,  stage_name, schedule, spotify_id, facebook, twitter, instagram) VALUES(?,?,?,?,?,?,?,?,?,?,?,?)";artist.name.toUpperCase().charCodeAt(0)>90&&(artist.name="!"+artist.name);var params=[artist.id,artist.name,artist.description,artist.image_profile,artist.image_cover,artist.stage_id,artist.stage_name,artist.schedule.date,artist.spotify_id,artist.facebook,artist.twitter,artist.instagram];return DBService.query(sql,params).then(function(response){return response})["catch"](function(error){console.log(error)})}function drop(){return DBService.query("DROP TABLE IF EXISTS artists").then(function(result){return DBService.fetch(result)})}function getAll(){return DBService.query("SELECT * FROM artists").then(function(result){return DBService.fetchAll(result)})}function getById(id){return DBService.query("SELECT * FROM artists WHERE id = ?",[id]).then(function(result){return DBService.fetch(result)})}var resource=$resource(GLOBAL.api.url+GLOBAL.api.version+"/artists",{},{getAll:{method:"GET",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/artists/"+GLOBAL.api.feast}});return{resource:resource,add:add,drop:drop,getAll:getAll,getById:getById}}),app.factory("DBService",function($q,DB_CONFIG){var self=this;return self.db=null,self.init=function(){self.db=window.openDatabase(DB_CONFIG.name,"1.0","database",-1),self.query("DROP TABLE IF EXISTS artists"),angular.forEach(DB_CONFIG.tables,function(table){var columns=[];angular.forEach(table.columns,function(column){columns.push(column.name+" "+column.type)});var query="CREATE TABLE "+table.name+" ("+columns.join(",")+")";self.query(query),console.log("Table "+table.name+" initialized")})},self.query=function(query,bindings){bindings="undefined"!=typeof bindings?bindings:[];var deferred=$q.defer();return self.db.transaction(function(transaction){transaction.executeSql(query,bindings,function(transaction,result){deferred.resolve(result)},function(transaction,error){deferred.reject(error)})}),deferred.promise},self.fetchAll=function(result){for(var output=[],i=0;i<result.rows.length;i++)output.push(result.rows.item(i));return output},self.fetch=function(result){return result.rows.item(0)},self}),app.factory("FacebookService",function($rootScope,GLOBAL,$http,$q,$localStorage){function fetchFeed(){var deferred=$q.defer();return $http.get("https://graph.facebook.com/"+GLOBAL.facebook.user_id+"/feed?fields=likes,comments,link,from,message,created_time,picture&"+$localStorage.accessToken).success(function(response){deferred.resolve(response)}).error(function(){}),deferred.promise}function getAccessToken(){var deferred=$q.defer();return $http.get("https://graph.facebook.com/oauth/access_token?client_id="+GLOBAL.facebook.client_id+"&client_secret="+GLOBAL.facebook.client_secret+"&grant_type=client_credentials").success(function(response){deferred.resolve(response)}).error(function(){}),deferred.promise}function getProfilePicture(){var deferred=$q.defer();return $http.get("https://graph.facebook.com/"+GLOBAL.facebook.user_id+"?"+$localStorage.accessToken+"&fields=picture&format=json").success(function(response){deferred.resolve(response.picture.data.url)}).error(function(){}),deferred.promise}return{fetchFeed:fetchFeed,getAccessToken:getAccessToken,getProfilePicture:getProfilePicture}}),app.factory("InstagramService",function($rootScope,$http,GLOBAL){function fetchImages(callback){var endPoint="https://api.instagram.com/v1/users/"+GLOBAL.instagram.user_id+"/media/recent/?client_id="+GLOBAL.instagram.client_id+"&callback=JSON_CALLBACK";$http.jsonp(endPoint).success(function(response){callback(response.data)})}return{fetchImages:fetchImages}}),app.factory("playerService",function($rootScope,Spotify,GLOBAL){var service={};return service.getTopTracks=function(spotifyId){Spotify.getArtistTopTracks(spotifyId,GLOBAL.spotify.country_iso).then(function(data){$rootScope.$broadcast("top_tracks",data.tracks)})},service.openSpotify=function(link){window.open(link,"_blank","location=yes")},service}),app.factory("TimeService",function($rootScope,GLOBAL,$http,$q,$localStorage){return{dhms:function(t){var days,hours,minutes,seconds;days=Math.floor(t/86400),t-=86400*days,hours=Math.floor(t/3600)%24,t-=3600*hours,minutes=Math.floor(t/60)%60,t-=60*minutes,seconds=t%60;var hoursTotal=hours+24*days;return[hoursTotal+" horas",minutes+" minutos"].join(" ")}}}),app.factory("UserService",function($rootScope,Spotify){var service={};return service.isLogged=function(){return window.localStorage.getItem("is_logged")},service});