var app=angular.module("festival",["ionic","ngCordova","ngCordovaOauth","angular.filter","ngStorage","ngResource","ngTwitter","spotify","ionic-zoom-view"]);app.run(function($rootScope,$state,$stateParams,$ionicPlatform,$ionicHistory,$state,UserService,NotificationService){$ionicPlatform.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleDefault(),$ionicPlatform.registerBackButtonAction(function(event){if("base.login"!=$state.current.name&&"base.register"!=$state.current.name||!UserService.isLogged())if("base.login"==$state.current.name||"base.register"==$state.current.name)event.preventDefault(),navigator.app.exitApp();else switch(event.preventDefault(),$ionicHistory.currentView().stateId){case"menu.artist-list":$ionicHistory.clearHistory(),$state.go("menu.artist-discover");break;case"menu.poster":$ionicHistory.clearHistory(),$state.go("menu.artist-discover");break;case"menu.schedule":$ionicHistory.clearHistory(),$state.go("menu.artist-discover");break;case"menu.map":$ionicHistory.clearHistory(),$state.go("menu.artist-discover");break;case"menu.ticket":$ionicHistory.clearHistory(),$state.go("menu.artist-discover");break;case"menu.coolway":$ionicHistory.clearHistory(),$state.go("menu.artist-discover");break;case"menu.info":$ionicHistory.clearHistory(),$state.go("menu.artist-discover");break;default:$ionicHistory.goBack()}else event.preventDefault(),navigator.app.exitApp()},100),UserService.isLogged()||($state.go("base.login"),console.info("redirect login")),$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){"base.login"!=toState.name&&"base.register"!=toState.name||!UserService.isLogged()||(event.preventDefault(),navigator.app.exitApp())})})}),app.config(function($stateProvider,$urlRouterProvider,$ionicConfigProvider){$ionicConfigProvider.backButton.text("").icon("my-back-button"),$stateProvider.state("base",{url:"/","abstract":!0,templateUrl:"templates/base.html",controller:"BaseController"}).state("base.login",{url:"login",views:{content:{templateUrl:"templates/user/sign_in.html",controller:"LoginController",resolve:{data:function($ionicPlatform,UserService,$state){$ionicPlatform.ready(function(){UserService.isLogged()?($state.go("menu.artist-discover"),console.info("is logged")):console.info("is not logged")})}}}}}).state("base.register",{url:"register",views:{content:{templateUrl:"templates/user/sign_up.html",controller:"RegisterController",resolve:{data:function($ionicPlatform,UserService,$state){$ionicPlatform.ready(function(){UserService.isLogged()?($state.go("menu.artist-discover"),console.info("is logged")):console.info("is not logged")})}}}}}).state("base.recover",{url:"recover",views:{content:{templateUrl:"templates/user/recover_password.html",controller:"RecoverController",resolve:{data:function($ionicPlatform,UserService,$state){$ionicPlatform.ready(function(){UserService.isLogged()?($state.go("menu.artist-discover"),console.info("is logged")):console.info("is not logged")})}}}}}).state("menu",{url:"/app/","abstract":!0,templateUrl:"templates/menu/main.html",controller:"MenuController"}).state("menu.artist-discover",{url:"artists/discover",views:{content:{templateUrl:"templates/artist/main.html",controller:"ArtistController"}}}).state("menu.artist-list",{url:"artists",views:{content:{templateUrl:"templates/artist/list.html",controller:"ArtistController"}}}).state("menu.artist-detail",{url:"artist/:id",views:{content:{templateUrl:"templates/artist/detail.html",controller:"ArtistController"}}}).state("menu.poster",{url:"poster",views:{content:{templateUrl:"templates/poster/main.html",controller:"PosterController"}}}).state("menu.schedule",{url:"schedule",views:{content:{templateUrl:"templates/schedule/main.html",controller:"ScheduleController"}}}).state("menu.map",{url:"map",views:{content:{templateUrl:"templates/map/main.html",controller:"MapController"}}}).state("menu.ticket",{url:"ticket",views:{content:{templateUrl:"templates/ticket/main.html",controller:"TicketController"}}}).state("menu.coolway",{url:"coolway",views:{content:{templateUrl:"templates/coolway/main.html",controller:"CoolwayController"}}}).state("menu.streaming",{url:"streaming",views:{content:{templateUrl:"templates/streaming/main.html",controller:"StreamingController"}}}).state("menu.info",{url:"info",views:{content:{templateUrl:"templates/info/main.html",controller:"InfoController"}}}).state("menu.map-how-get",{url:"map-how-get",views:{content:{templateUrl:"templates/info/map.html",controller:"MapHowGetController"}}}).state("menu.sponsor",{url:"sponsor",views:{content:{templateUrl:"templates/info/sponsor.html"}}}).state("menu.weather",{url:"weather",views:{content:{templateUrl:"templates/info/weather.html"}}}).state("menu.social",{url:"social",views:{content:{templateUrl:"templates/social/main.html",controller:"SocialController"}}}),$urlRouterProvider.otherwise("/app/artists/discover"),$ionicConfigProvider.views.maxCache(0)}),app.constant("DB_CONFIG",{name:"DB",tables:[{name:"artists",erasable:!0,columns:[{name:"id",type:"integer"},{name:"name",type:"text"},{name:"description",type:"text"},{name:"image_profile",type:"text"},{name:"image_cover",type:"text"},{name:"stage_id",type:"text"},{name:"stage_name",type:"text"},{name:"schedule",type:"text"},{name:"spotify_id",type:"text"},{name:"facebook",type:"text"},{name:"twitter",type:"text"},{name:"instagram",type:"text"}]},{name:"favorites",erasable:!1,columns:[{name:"artist_id",type:"integer"},{name:"user_id",type:"integer"}]},{name:"posters",erasable:!0,columns:[{name:"id",type:"integer"},{name:"image",type:"text"}]},{name:"maps",erasable:!0,columns:[{name:"id",type:"integer PRIMARY KEY AUTOINCREMENT"},{name:"name",type:"text"},{name:"image",type:"text"},{name:"latitude",type:"text"},{name:"longitude",type:"text"}]},{name:"locations",erasable:!0,columns:[{name:"id",type:"integer PRIMARY KEY AUTOINCREMENT"},{name:"name",type:"text"},{name:"detail",type:"text"},{name:"image",type:"text"},{name:"latitude",type:"text"},{name:"longitude",type:"text"}]}]}),app.constant("GLOBAL",{api:{url:"http://gravedadprod.mobi/app_dev.php/api/",version:"v1",feast:1},server:{image:"http://gravedadprod.mobi/uploads/"},spotify:{country_iso:"ES",user_id:"festivaldelesarts",client_id:"77b0545674984c768ed449759d5911c8",playlist_id:"4wGfReMLNIEHqJ3dySeKnQ"},facebook:{api_version:"v2.5",user_id:"850431581647988",client_id:"1706543149628857",client_secret:"99a5617adda2ef35f914ab9f01dbc626"},instagram:{user_id:"1545629618",client_id:"642176ece1e7445e99244cec26f4de1f"}}),app.directive("countdown",["TimeService","$interval",function(TimeService,$interval){return{restrict:"A",scope:{date:"@"},link:function(scope,element){var future;future=new Date(scope.date),$interval(function(){var diff;return diff=Math.floor((future.getTime()-(new Date).getTime())/1e3),element.text(TimeService.dhms(diff))},1e3)}}}]),app.directive("favorite",["FavoriteService","UserService","$ionicPopup","$state",function(FavoriteService,UserService,$ionicPopup,$state){return{restrict:"AE",replace:!0,template:'<button data-ng-click="change(data.status)" class="button button-clear favorite"><img ng-src="img/favorite/{{data.status}}.png"> </button>',scope:{artist:"="},link:function($scope,elem,attrs){function remove(artistId){FavoriteService.remove(artistId),$scope.data.status="off",$scope.$emit("favorite:change",!0)}function add(artistId){FavoriteService.add(artistId),$scope.data.status="on",$scope.$emit("favorite:change",!0)}$scope.data={artist:$scope.artist},console.info("in",$scope.data.artist),UserService.isLogged()?"undefined"!=typeof $scope.data.artist&&FavoriteService.getArtistById($scope.data.artist.id).then(function(response){"undefined"==typeof response.artist_id?$scope.data.status="off":$scope.data.status="on"}):$scope.data.status="off",$scope.change=function(status){if(UserService.isLogged())"on"==status?remove($scope.data.artist.id):add($scope.data.artist.id);else{var confirmPopup=$ionicPopup.confirm({title:"Iniciar sesiÃ³n",template:"Para agregar favoritos debes estar logeado"});confirmPopup.then(function(response){response&&$state.go("base.login")})}}}}}]),app.directive("lazyLoad",["$window","$q",function($window,$q){function load_script(){var s=document.createElement("script");s.src="/www.ticketea.com/entradas-festival-les-arts-2016/buy?width=600px&height=600px",document.body.appendChild(s)}function lazyLoadApi(key){var deferred=$q.defer();return $window.initialize=function(){deferred.resolve()},$window.attachEvent?$window.attachEvent("onload",load_script):$window.addEventListener("load",load_script,!1),deferred.promise}return{restrict:"E",link:function(scope,element,attrs){$window.google&&$window.google.maps?console.log("gmaps already loaded"):lazyLoadApi().then(function(){console.log("promise resolved"),$window.google&&$window.google.maps?console.log("gmaps loaded"):console.log("gmaps not loaded")},function(){console.log("promise rejected")})}}}]),app.controller("accountCtrl",function($scope,$state){$scope.state=$state}),app.controller("ArtistController",function($rootScope,$scope,DBService,$state,$filter,$ionicPopup,$ionicScrollDelegate,filterFilter,$anchorScroll,ArtistService,SpotifyService,GLOBAL,$ionicActionSheet,$ionicLoading,$stateParams,$cordovaSocialSharing,MusicService,VersionService,$localStorage){if($scope.init=function(){$scope.view={},$scope.view.ready=!1,$scope.view.server_image=GLOBAL.server.image,$scope.view.feast_id=GLOBAL.api.feast,$scope.audio=new Audio,$scope.pause=!0,$scope.view.currentDate=$filter("date")(new Date,"yyyy-MM-dd"),$scope.view.feastDate=$filter("date")(new Date("2016-06-10"),"yyyy-MM-dd")},$scope.init(),$scope.showDetail=function(id){return id>0?void $state.go("menu.artist-detail",{id:id}):!1},self.getArtists=function(sort){ArtistService.getAll().then(function(artists){artists.length>0?($scope.view.artists=artists,sort===!0&&self.sort(),$scope.view.ready=!0,$scope.$emit("artist:ready",!0)):($ionicLoading.show({content:"Cargando",animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0}),ArtistService.resource.getAll().$promise.then(function(artists){$scope.view.artists=artists.data,sort===!0&&self.sort(),angular.forEach(artists.data,function(value,key){ArtistService.add(value)}),$ionicLoading.hide(),$scope.view.ready=!0,$scope.$emit("artist:ready",!0)},function(error){$ionicLoading.hide(),$scope.view.ready=!0}))})},self.sort=function(){function addLetter(code){var letter=String.fromCharCode(code);artists.push({isLetter:!0,letter:letter}),letters.push(letter)}var currentCharCode=" ".charCodeAt(0)-1;$scope.view.artists.sort(function(a,b){return a.name>b.name?1:-1}).forEach(function(artist){var artistCharCode=artist.name.toUpperCase().charCodeAt(0);65>artistCharCode&&(artistCharCode=35);for(var difference=artistCharCode-currentCharCode,i=1;difference>=i;i++)addLetter(currentCharCode+i);currentCharCode=artistCharCode,artists.push(artist)});for(var i=currentCharCode+1;i<="Z".charCodeAt(0);i++)addLetter(i)},"menu.artist-list"==$state.current.name){var letters=$scope.letters=[],artists=$scope.artists=[];self.getArtists(!0),$scope.getItemHeight=function(item){return item.isLetter?40:100},$scope.scrollTop=function(){$ionicScrollDelegate.scrollTop()},$scope.scrollBottom=function(){$ionicScrollDelegate.scrollBottom()};var letterHasMatch={};$scope.getArtistsList=function(){return letterHasMatch={},artists.filter(function(item){var itemDoesMatch=!$scope.view.search||item.isLetter||item.name.toLowerCase().indexOf($scope.view.search.toLowerCase())>-1;if(!item.isLetter&&itemDoesMatch){var letter=item.name.charAt(0).toUpperCase();item.name.charCodeAt(0)<65&&(letter="#"),letterHasMatch[letter]=!0}return itemDoesMatch}).filter(function(item){return item.isLetter&&!letterHasMatch[item.letter]?!1:!0})},$scope.clearSearch=function(){$scope.view.search=""}}"menu.artist-discover"==$state.current.name&&($localStorage.lastUpdate!=$scope.view.currentDate?VersionService.resource.get().$promise.then(function(response){if(response.data.version!=$localStorage.version){var confirmPopup=$ionicPopup.confirm({title:"Nueva actualizaciÃ³n",template:"Â¿Desea descargar los nuevos datos?"});confirmPopup.then(function(confirm){confirm?(DBService.init(!0),self.getArtists(!1),$localStorage.version=response.data.version,$localStorage.lastUpdate=$filter("date")(new Date,"yyyy-MM-dd")):(self.getArtists(!1),$localStorage.lastUpdate=$filter("date")(new Date,"yyyy-MM-dd"))})}else self.getArtists(!1)},function(error){self.getArtists(!1)}):self.getArtists(!1),$scope.playTrack=function(artist){$rootScope.$broadcast("music:clear",!0),$scope.view.isPause&&$scope.view.currentTrack.spotify_id==artist.spotify_id?MusicService.play():SpotifyService.getTopTracks(artist.spotify_id).then(function(tracks){var track={};track.spotify_id=artist.spotify_id,track.artist=tracks[0].artists[0].name,track.name=tracks[0].name,track.url=tracks[0].preview_url,MusicService.clear(),MusicService.add(track,!1),MusicService.play()})},$scope.pauseTrack=function(){MusicService.pause()},$scope.$on("music:play",function(event,args){$scope.view.isPlaying=!0,$scope.view.isPause=!1,$scope.view.currentTrack=args}),$scope.$on("music:pause",function(event,args){$scope.view.isPlaying=!1,$scope.view.isPause=!0,$scope.view.currentTrack=args})),"menu.artist-detail"==$state.current.name&&(ArtistService.getById($stateParams.id).then(function(artist){$scope.view.artist=artist,$scope.view.ready=!0}),$scope.playTrack=function(artist){$rootScope.$broadcast("music:clear",!0),$scope.view.isPause&&$scope.view.currentTrack.spotify_id==artist.spotify_id?MusicService.play():SpotifyService.getTopTracks(artist.spotify_id).then(function(tracks){var track={};track.spotify_id=artist.spotify_id,track.artist=tracks[0].artists[0].name,track.name=tracks[0].name,track.url=tracks[0].preview_url,MusicService.clear(),MusicService.add(track,!1),MusicService.play()})},$scope.shareAnywhere=function(artist){var name=artist.name,image=$scope.view.server_image+"artists/"+artist.id+"/cover/"+artist.image_cover;$cordovaSocialSharing.share("Te recomiendo "+name+" en el #FestivalDeLesArts","Festival de les arts",image,"http://www.festivaldelesarts.com/")})}),app.controller("BaseController",function($scope,$state){$scope.init=function(){$scope.state=$state,$scope.view={},$scope.view.navigation=!1,$scope.view.show="sign_in"},$scope.init(),$scope.openLink=function(link){window.open(link,"_system","location=yes")},$scope.login=function(){$scope.view.show="sign_in",$state.go("base.login")},$scope.register=function(){$state.go("base.register"),$scope.view.show="sign_up"}}),app.controller("CoolwayController",function($scope,CoolwayService,GLOBAL,$ionicLoading,$state,$stateParams,$cordovaSocialSharing){$scope.loadPhotos=function(){$ionicLoading.show({content:"Cargando",animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0}),CoolwayService.resource.getAll().$promise.then(function(photos){console.info("photos",photos.data),$scope.view.photos=photos.data,$ionicLoading.hide(),$scope.view.ready=!0})},$scope.init=function(){$scope.view={},$scope.view.photos={},$scope.view.server_image=GLOBAL.server.image,$scope.view.feast_id=GLOBAL.api.feast,$scope.loadPhotos()},$scope.init(),$scope.showDetail=function(image){$state.go("menu.coolway-detail",{image:image})},"menu.coolway-detail"==$state.current.name&&(console.info("$stateParams.image",$stateParams.image),$scope.view.image=$stateParams.image),$scope.openPage=function(type,url){var scheme,link;if("BROWSER"==type)window.open(url,"_system","location=yes");else{switch(type){case"FACEBOOK":link="fb://publish/profile/345546062072",scheme=ionic.Platform.isAndroid()?"com.facebook.katana":"fb://";break;case"TWITTER":link="twitter://user?screen_name=coolwayspain",scheme=ionic.Platform.isAndroid()?"com.twitter.android":"twitter://";break;case"INSTAGRAM":link="instagram://user?username=coolway_spain",scheme=ionic.Platform.isAndroid()?"com.instagram.android":"instagram://"}appAvailability.check(scheme,function(){window.open(link,"_system","location=no")},function(){window.open(url,"_system","location=yes")})}},$scope.shareImage=function(image){console.info("image",image),$cordovaSocialSharing.share(null,null,image,null)}}),app.controller("FavoriteController",function($scope){$scope.init=function(){$scope.view={}}}),app.controller("InfoController",function($scope,$state){$scope.init=function(){$scope.view={}},$scope.init(),$scope.go=function(state){$state.go(state)}}),app.controller("LoginController",function($scope,$state,$http,$ionicLoading,GLOBAL,$ionicPopup,$cordovaOauth,UserService){$scope.init=function(){$scope.view={},$scope.view.show="sign_in",$scope.view.show_login="options",$scope.view.user=new UserService.resource,$scope.view.loginEmail=!1},$scope.init(),$scope.later=function(){$state.go("menu.artist-discover")},$scope.loginFacebook=function(){$cordovaOauth.facebook(GLOBAL.facebook.client_id,["email"]).then(function(result){$ionicLoading.show({template:"Verificando ..."}),$http.get("https://graph.facebook.com/"+GLOBAL.facebook.api_version+"/me",{params:{access_token:result.access_token,fields:"id,email,name",format:"json"}}).then(function(result){console.info("result",result),$scope.view.user.email=result.data.email,$scope.view.user.name=result.data.name,$scope.view.user.social=!0,$scope.view.user.$login(function(response){UserService.setUser(response),$state.go("menu.artist-discover"),$ionicLoading.hide()},function(error){$ionicLoading.hide(),$ionicPopup.alert({title:error.data.message})})},function(){$ionicLoading.hide(),$ionicPopup.alert({title:"Error Intente Nuevamente"})})},function(){$ionicLoading.hide(),$ionicPopup.alert({title:"Error Intente Nuevamente"})})},$scope.toggleLoginEmail=function(){$scope.view.loginEmail=!$scope.view.loginEmail},$scope.login=function(){$scope.view.user.email&&UserService.validateEmail($scope.view.user.email)?$scope.view.user.password?($ionicLoading.show({template:"Iniciando..."}),$scope.view.user.$login(function(response){UserService.setUser(response),$state.go("menu.artist-discover"),$ionicLoading.hide()},function(error){$ionicLoading.hide(),$ionicPopup.alert({title:error.data.message})})):$ionicPopup.alert({title:"Ingrese su contraseÃ±a"}):$ionicPopup.alert({title:"Ingrese un email valido"})}}),app.controller("MainController",function($scope){$scope.init=function(){$scope.view={}},$scope.init()}),app.controller("MapHowGetController",function($scope,$cordovaGeolocation,$ionicLoading,GLOBAL,MapService,$cordovaDevice){self.getMapAndLocations=function(){return MapService.resource.getAll().$promise.then(function(map){return map},function(error){return error})},$scope.init=function(){$scope.server_image=GLOBAL.server.image,$scope.view.ready=!1,$ionicLoading.show({content:"Cargando",animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0}),MapService.getAll().then(function(map){map.length>0?($scope.mapData=map[0],self.loadMap()):self.getMapAndLocations().then(function(map){$scope.mapData=map.data,MapService.add(map.data),self.loadMap()}),$ionicLoading.hide(),$scope.view.ready=!0})},self.loadMap=function(){$scope.mapData.latitude.length>0&&($scope.centroLatlng=new google.maps.LatLng($scope.mapData.latitude,$scope.mapData.longitude));var mapOptions={center:$scope.centroLatlng,zoom:15,maxZoom:19,streetViewControl:!1,zoomControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP},map=new google.maps.Map(document.getElementById("map-how-get"),mapOptions);$scope.map=map,$scope.directionsDisplay=new google.maps.DirectionsRenderer({polylineOptions:{strokeColor:"red"}});new google.maps.Marker({position:$scope.centroLatlng,map:$scope.map});$scope.map.setZoom(15),$scope.map.setCenter($scope.centroLatlng)},$scope.goFromMyLocation=function(mode){document.getElementById("id_waiting").style.visibility="visible",navigator.geolocation.getCurrentPosition(function(position){var myLocation=new google.maps.LatLng(position.coords.latitude,position.coords.longitude),directionsService=new google.maps.DirectionsService;$scope.directionsDisplay.setMap($scope.map),directionsService.route({origin:myLocation,destination:$scope.centroLatlng,travelMode:google.maps.TravelMode[mode]},function(response,status){status===google.maps.DirectionsStatus.OK?$scope.directionsDisplay.setDirections(response):window.alert("No disponible para realizar el recorrido")}),document.getElementById("id_waiting").style.visibility="hidden"})},$scope.init()}),app.controller("MapController",function($scope,$cordovaGeolocation,$ionicLoading,$cordovaDevice,GLOBAL,MapService){self.getMapAndLocations=function(){return MapService.resource.getAll().$promise.then(function(map){return map},function(error){return error})},$scope.init=function(){$scope.server_image=GLOBAL.server.image,$scope.view.ready=!1,$ionicLoading.show({content:"Cargando",animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0}),MapService.getAll().then(function(map){map.length>0?($scope.mapData=map[0],MapService.getAllLocations().then(function(locations){locations.length>0?($scope.locations=locations,self.loadMap()):self.getMapAndLocations().then(function(map){$scope.mapData=map.data,$scope.locations=[],MapService.add(map.data);var cont=0;angular.forEach(map.data.locations,function(value,key){MapService.addLocation(value),$scope.locations.push(value),cont+=1}),self.loadMap()})})):self.getMapAndLocations().then(function(map){$scope.mapData=map.data,$scope.locations=[],MapService.add(map.data);var cont=0;angular.forEach(map.data.locations,function(value,key){MapService.addLocation(value),$scope.locations.push(value),cont+=1}),self.loadMap()}),$ionicLoading.hide(),$scope.view.ready=!0})},self.loadMap=function(){var marker,i,imgOver,infoWindow=new google.maps.InfoWindow;$scope.mapData.latitude.length>0&&($scope.centroLatlng=new google.maps.LatLng($scope.mapData.latitude,$scope.mapData.longitude));var mapOptions={center:$scope.centroLatlng,streetViewControl:!1,zoomControl:!1,zoom:15,maxZoom:19,mapTypeId:google.maps.MapTypeId.ROADMAP},map=new google.maps.Map(document.getElementById("map"),mapOptions);$scope.locations.length>0&&angular.forEach($scope.locations,function(value,key){marker=new google.maps.Marker({position:new google.maps.LatLng(value.latitude,value.longitude),map:map,title:value.name,icon:new google.maps.MarkerImage($scope.server_image+"googlemap/"+value.image)}),google.maps.event.addListener(marker,"click",function(marker,i){return function(){infoWindow.setContent(value.detail),infoWindow.open(map,marker)}}(marker,i))});var imageBounds={north:39.458577,south:39.452215,east:-.347785,west:-.356626},overlayOpts={opacity:1};imgOver=new google.maps.GroundOverlay("img/map/precint.png",imageBounds,overlayOpts),imgOver.setMap(map),$scope.map=map,$scope.directionsDisplay=new google.maps.DirectionsRenderer({polylineOptions:{strokeColor:"red"}});new google.maps.Marker({position:$scope.centroLatlng,map:$scope.map});$scope.map.setZoom(15),$scope.map.setCenter($scope.centroLatlng)},$scope.showMyLocation=function(){document.getElementById("id_waiting").style.visibility="visible",navigator.geolocation.getCurrentPosition(function(position){console.info("my location",position);var mypos=new google.maps.LatLng(position.coords.latitude,position.coords.longitude);new google.maps.Marker({position:mypos,map:$scope.map,icon:"img/map/my-location-icon.png"});$scope.map.setZoom(17),$scope.map.setCenter(mypos),document.getElementById("id_waiting").style.visibility="hidden"})},$scope.init()}),app.controller("MenuController",function($rootScope,$scope,$ionicModal,$ionicPopup,$ionicPlatform,DBService,$state,GLOBAL,Spotify,UserService,$ionicLoading,FavoriteService,ArtistService,NotificationService,WeatherService,$cordovaSocialSharing,$filter){$scope.init=function(){console.info("init db"),DBService.init(),$scope.view={},$scope.view.server_image=GLOBAL.server.image,$scope.view.show_list="favorites",$scope.view.favorites=!1,$scope.view.notifications=!1,$scope.view.setting={},$scope.view.setting.notifications=!0,$scope.view.pass=new UserService.resource,$scope.view.weathers={},UserService.isLogged()&&($scope.view.user=UserService.getUser())},$scope.init(),$scope.$on("favorite:change",function(event,args){console.info("favorite change"),UserService.isLogged()&&self.getFavorites()}),$scope.$on("artist:ready",function(event,args){UserService.isLogged()?(console.info("entro favoritos logeados"),self.getFavorites(),self.getNotifications()):console.info("no logged")}),self.getFavorites=function(){FavoriteService.getAll().then(function(favorites){if(console.info("database favs out",favorites),favorites.length>0){var ids=[];angular.forEach(favorites,function(value,key){ids.push(value.artist_id)}),ArtistService.getFavorites(ids).then(function(favorites){console.info("database favs",favorites),$scope.view.favorites=favorites,$scope.view.ready=!0})}else console.info("api favs 1"),FavoriteService.resource.getAll().$promise.then(function(favorites){if(favorites.data.length>0){var ids=[];angular.forEach(favorites.data,function(value,key){FavoriteService.add(value.id),ids.push(value.id)}),ArtistService.getFavorites(ids).then(function(favorites){console.info("api favs final",favorites),$scope.view.favorites=favorites,$scope.view.ready=!0})}else $scope.view.favorites={},$scope.view.ready=!0},function(error){console.info("error",error),$scope.view.ready=!0})})},self.getNotifications=function(){NotificationService.resource.getAll().$promise.then(function(notifications){console.info("notifications",notifications),notifications.data.length>0?$scope.view.notifications=notifications.data:($scope.view.notifications={},$scope.view.ready=!0)},function(error){console.info("error",error),$scope.view.ready=!0})},$ionicModal.fromTemplateUrl("templates/user/settings.html",{scope:$scope}).then(function(modal){$scope.modalSettings=modal}),$scope.openSettings=function(){if(console.info($scope.view.user),UserService.isLogged())$scope.modalSettings.show();else{var confirmPopup=$ionicPopup.confirm({title:"Iniciar sesiÃ³n",template:"Para ingresar debes estar logeado"});confirmPopup.then(function(response){response&&$state.go("base.login")})}},$scope.closeSettings=function(){$scope.modalSettings.hide()},$scope.changePassword=function(){$scope.view.pass.current_password?$scope.view.pass.new_password?$scope.view.pass.new_password==$scope.view.confirm?$ionicPopup.alert({title:"Las contraseÃ±as deben ser iguales"}):$scope.view.pass.current_password.length<8||$scope.view.pass.new_password.length<8||$scope.view.pass.confirm.length<8?$ionicPopup.alert({title:"Las contraseÃ±a debe tener al menos 8 caracteres"}):($ionicLoading.show({template:"Actualizando..."}),$scope.view.pass.email=UserService.getUser().email,$scope.view.pass.$updatePassword(function(response){UserService.setUser(response),$ionicLoading.hide()},function(error){$ionicLoading.hide(),$ionicPopup.alert({title:error.data.message})})):$ionicPopup.alert({title:"Ingrese su nueva contraseÃ±a"}):$ionicPopup.alert({title:"Ingrese su contraseÃ±a actual"})},$scope.logout=function(){$ionicLoading.show({template:"Cerrando..."}),UserService.logout(),$state.go("base.login"),$scope.closeSettings(),$ionicLoading.hide()},$scope.openLink=function(link){window.open(link,"_system","location=yes")},$scope.showArtistDetail=function(id){return id>0?void $state.go("menu.artist-detail",{id:id}):!1},$scope.shareFavorites=function(){var message="";angular.forEach($scope.view.favorites,function(value,key){message+=" \r\n"+$filter("cleanName")(value.name)+" \r\n"+$filter("parseDate")(value.schedule)+" - "+$filter("parseDate")(value.schedule,"HH:mm")+"\r\n"+value.stage_name+" \r\n"}),$cordovaSocialSharing.share("Mis artistas favoritos  en el #FestivalDeLesArts: \r\n"+message,"Festival de les arts","","\r\n http://www.festivaldelesarts.com/")},$scope.getWeather=function(){console.info("weather afuera",$scope.view.weathers.length),$scope.view.weathers&&WeatherService.resource.getAll().$promise.then(function(weathers){console.info("weather",weathers),$scope.view.weathers=weathers.data})}}),app.controller("notificationController",function($scope){$scope.init=function(){$scope.view={}}}),app.controller("PlayerController",function($scope,$ionicModal,$cordovaOauth,$localStorage,Spotify,SpotifyService,$ionicLoading,GLOBAL,MusicService){$scope.init=function(){$scope.view={},$scope.view.playslist=[]},$scope.init(),$scope.performLogin=function(){$cordovaOauth.spotify(GLOBAL.spotify.client_id,["user-read-private","playlist-read-private"]).then(function(result){$localStorage.spotify_token=result.access_token,Spotify.setAuthToken(result.access_token),$scope.updateInfo()},function(error){console.log("Error -> "+error)})},$scope.loadPlayList=function(){$ionicLoading.show({content:"Cargando",animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0}),SpotifyService.gerPlayList().then(function(data){data.tracks.items.length>0&&($scope.view.playslist=data.tracks.items,MusicService.clear(),angular.forEach(data.tracks.items,function(value,key){var track={};track.spotify_id=value.track.id,track.artist=value.track.artists[0].name,track.name=value.track.name,track.url=value.track.preview_url,MusicService.add(track,!0)}),MusicService.play(),$scope.modal.show(),$ionicLoading.hide())})},$scope.updateInfo=function(){Spotify.getCurrentUser().then(function(data){$scope.loadPlayList()},function(error){$scope.performLogin()})},$ionicModal.fromTemplateUrl("templates/player/main.html",{scope:$scope}).then(function(modal){$scope.modal=modal}),$scope.openPlayList=function(){var storedToken=$localStorage.spotify_token;null!==storedToken?(Spotify.setAuthToken(storedToken),$scope.updateInfo()):$scope.performLogin()},$scope.openPlaylistModal=function(){$scope.modal.show()},$scope.closePlayer=function(){$scope.modal.hide()},$scope.playTrack=function(id){MusicService.play(id)},$scope.pauseTrack=function(){MusicService.pause()},$scope.$on("music:play",function(event,args){$scope.view.isPlaying=!0,$scope.view.isPause=!1,$scope.view.currentTrack=args}),$scope.$on("music:pause",function(event,args){$scope.view.isPlaying=!1,$scope.view.isPause=!0,$scope.view.currentTrack=args}),$scope.$on("music:clear",function(event,args){$scope.view.playslist=[]})}),app.controller("PosterController",function($scope,$cordovaGeolocation,$ionicLoading,GLOBAL,PosterService){$scope.init=function(){$scope.view.server_image=GLOBAL.server.image,$scope.view.feast=GLOBAL.api.feast,$scope.view.ready=!1,$ionicLoading.show({content:"Cargando",animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0}),PosterService.resource.getAll().$promise.then(function(poster){console.info("api",poster),$scope.view.poster=poster.data,$ionicLoading.hide()})},$scope.init()}),app.controller("RecoverController",function($scope,$state,$ionicLoading,$ionicPopup,UserService){$scope.init=function(){$scope.view={},$scope.view.user=new UserService.resource},$scope.init(),$scope.recoverPassword=function(){$scope.view.user.email&&UserService.validateEmail($scope.view.user.email)?($ionicLoading.show({template:"Recuperando contraseÃ±a..."}),$scope.view.user.$recoverPassword(function(response){$ionicPopup.alert({title:"La nueva contraseÃ±a ha sido enviada a su email"}),$state.go("base.login"),$ionicLoading.hide()},function(error){$ionicLoading.hide(),$ionicPopup.alert({title:error.data.message})})):$ionicPopup.alert({title:"Ingrese un email valido"})}}),app.controller("RegisterController",function($scope,$state,$ionicLoading,$ionicPopup,UserService){$scope.init=function(){$scope.view={},$scope.view.show="sign_up",$scope.view.show_login="options",$scope.view.user=new UserService.resource,$scope.view.loginEmail=!1},$scope.init(),$scope.signUp=function(){$scope.view.user.name?$scope.view.user.email&&UserService.validateEmail($scope.view.user.email)?$scope.view.user.password?$scope.view.user.password.length<8?$ionicPopup.alert({title:"Las contraseÃ±a debe tener al menos 8 caracteres"
}):($ionicLoading.show({template:"Registrando Cuenta ..."}),$scope.view.user.$register(function(response){UserService.setUser(response),$state.go("menu.artist-discover"),$ionicLoading.hide()},function(error){$ionicLoading.hide(),$ionicPopup.alert({title:error.data.message})})):$ionicPopup.alert({title:"Ingrese su contraseÃ±a"}):$ionicPopup.alert({title:"Ingrese un email valido"}):$ionicPopup.alert({title:"Ingrese su nombre"})}}),app.controller("ScheduleController",function($scope,ArtistService,$ionicLoading,GLOBAL,$state){$scope.init=function(){$scope.view={},$scope.view.ready=!1,$scope.view.show_list="time",$scope.view.show_day=9,$scope.view.server_image=GLOBAL.server.image},$scope.init(),$scope.showDetail=function(id){return id>0?void $state.go("menu.artist-detail",{id:id}):!1},self.getArtists=function(){ArtistService.getAll().then(function(artists){artists.length>0?(console.info("database",artists),$scope.view.artists=artists,$scope.view.ready=!0):($ionicLoading.show({content:"Cargando",animation:"fade-in",showBackdrop:!0,maxWidth:200,showDelay:0}),ArtistService.resource.getAll().$promise.then(function(artists){console.info("api",artists),$scope.view.artists=artists.data,angular.forEach(artists.data,function(value,key){ArtistService.add(value)}),$ionicLoading.hide(),$scope.view.ready=!0},function(error){console.info("error",error),$ionicLoading.hide(),$scope.view.ready=!0}))})},self.getArtists()}),app.controller("SocialController",function($scope,FacebookService,InstagramService,TwitterService,$localStorage){$scope.init=function(){$scope.view={},$scope.view.pics=[],$scope.newItemsIT=[],$scope.noMoreItemsAvailableIT=!1,$scope.have=[],$scope.view.orderBy="-likes.count",$scope.view.show="facebook"},$scope.init(),self.chunk=function(arr,size){for(var newArr=[],i=0;i<arr.length;i+=size)newArr.push(arr.slice(i,i+size));return console.info("return",newArr),newArr},$scope.correctTimestring=function(string){return new Date(Date.parse(string))},$scope.showTimeLine=function(){TwitterService.getTimeLine().then(function(data){$scope.view.twTimeline=data},function(error){console.info(error)})},$scope.doRefresh=function(){$scope.showTimeLine(),$scope.$broadcast("scroll.refreshComplete")},$scope.loadTwitter=function(){$scope.view.show="twitter",TwitterService.isAuthenticated()?$scope.showTimeLine():TwitterService.initialize().then(function(result){result===!0&&$scope.showTimeLine()})},$scope.getData=function(){InstagramService.GetFeed().then(function(items){$scope.view.pics=items.concat($scope.items)}),$localStorage.hasOwnProperty("fbAccessToken")===!0?(FacebookService.fetchFeed().then(function(response){$scope.view.facebookFeed=response.data,console.info("facebook",$scope.view.facebookFeed)}),FacebookService.getProfilePicture().then(function(response){$scope.view.facebookPicture=response})):FacebookService.getAccessToken().then(function(data){$localStorage.fbAccessToken=data,FacebookService.fetchFeed().then(function(response){$scope.view.facebookFeed=response.data,console.info("facebook",$scope.view.facebookFeed)})})},$scope.getData(),$scope.doRefreshInstagram=function(){$scope.newItems.length>0?($scope.view.pics=$scope.newItems.concat($scope.view.pics),$scope.$broadcast("scroll.refreshComplete"),$scope.newItems=[]):InstagramService.GetNewPhotos().then(function(items){$scope.view.pics=items.concat($scope.view.pics),$scope.$broadcast("scroll.refreshComplete")})},$scope.LoadMoreInstagram=function(){InstagramService.GetOldPhotos().then(function(items){$scope.view.pics=$scope.view.pics.concat(items),$scope.$broadcast("scroll.infiniteScrollComplete"),0===items.length&&($scope.noMoreItemsAvailableIT=!0)})}}),app.controller("StreamingController",function($scope){$scope.init=function(){$scope.view={}}}),app.controller("TicketController",function($scope){$scope.init=function(){$scope.view={}}}),app.filter("cleanName",function(){return function(text){return"undefined"==typeof text?text:text.replace("!","")}}),app.filter("parseDate",function($filter){return function(text,type){if("undefined"==typeof text)return text;var date=new Date(text.replace(/-/g,"/"));return $filter("date")(date,type)}}),app.factory("ArtistService",function($rootScope,$resource,GLOBAL,DBService){function add(artist){var sql="INSERT OR IGNORE INTO artists (id, name, description, image_profile, image_cover, stage_id,  stage_name, schedule, spotify_id, facebook, twitter, instagram) VALUES(?,?,?,?,?,?,?,?,?,?,?,?)";artist.name.toUpperCase().charCodeAt(0)>90&&(artist.name="!"+artist.name);var params=[artist.id,artist.name,artist.description,artist.image_profile,artist.image_cover,artist.stage_id,artist.stage_name,artist.schedule.date,artist.spotify_id,artist.facebook,artist.twitter,artist.instagram];return DBService.query(sql,params).then(function(response){return response})["catch"](function(error){console.log(error)})}function drop(){return DBService.query("DROP TABLE IF EXISTS artists").then(function(result){return DBService.fetch(result)})}function getAll(){return DBService.query("SELECT * FROM artists").then(function(result){return DBService.fetchAll(result)})}function getFavorites(ids){var args="";for(i=1;i<=ids.length;i++)args+="?",i<ids.length&&(args+=",");console.info("ids",ids);var sql="SELECT * FROM artists WHERE id IN ("+args+")";return DBService.query(sql,ids).then(function(result){return console.log("result all",result),DBService.fetchAll(result)})["catch"](function(error){console.log(error)})}function getById(id){return DBService.query("SELECT * FROM artists WHERE id = ?",[id]).then(function(result){return DBService.fetch(result)})}var resource=$resource(GLOBAL.api.url+GLOBAL.api.version+"/artists",{},{getAll:{method:"GET",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/artists/"+GLOBAL.api.feast}});return{resource:resource,add:add,drop:drop,getAll:getAll,getById:getById,getFavorites:getFavorites}}),app.factory("CoolwayService",function($rootScope,$resource,GLOBAL,DBService){var resource=$resource(GLOBAL.api.url+GLOBAL.api.version+"/coolways",{},{getAll:{method:"GET",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/coolways/"+GLOBAL.api.feast}});return{resource:resource}}),app.factory("DBService",function($q,DB_CONFIG){var self=this;return self.db=null,self.init=function(drop){self.db=window.openDatabase(DB_CONFIG.name,"1.0","database",-1),angular.forEach(DB_CONFIG.tables,function(table){var columns=[];drop&&table.erasable&&self.query("DROP TABLE IF EXISTS "+table.name),angular.forEach(table.columns,function(column){columns.push(column.name+" "+column.type)});var query="CREATE TABLE "+table.name+" ("+columns.join(",")+")";self.query(query)})},self.query=function(query,bindings){bindings="undefined"!=typeof bindings?bindings:[];var deferred=$q.defer();return self.db.transaction(function(transaction){transaction.executeSql(query,bindings,function(transaction,result){deferred.resolve(result)},function(transaction,error){deferred.reject(error)})}),deferred.promise},self.fetchAll=function(result){for(var output=[],i=0;i<result.rows.length;i++)output.push(result.rows.item(i));return output},self.fetch=function(result){return result.rows.item(0)},self}),app.factory("FacebookService",function($rootScope,GLOBAL,$http,$q,$localStorage){function fetchFeed(){var deferred=$q.defer();return $http.get("https://graph.facebook.com/"+GLOBAL.facebook.user_id+"/feed?fields=likes,comments,link,from,message,created_time,picture&"+$localStorage.fbAccessToken).success(function(response){deferred.resolve(response)}).error(function(){}),deferred.promise}function getAccessToken(){var deferred=$q.defer();return $http.get("https://graph.facebook.com/oauth/access_token?client_id="+GLOBAL.facebook.client_id+"&client_secret="+GLOBAL.facebook.client_secret+"&grant_type=client_credentials").success(function(response){deferred.resolve(response)}).error(function(){}),deferred.promise}function getProfilePicture(){var deferred=$q.defer();return $http.get("https://graph.facebook.com/"+GLOBAL.facebook.user_id+"?"+$localStorage.fbAccessToken+"&fields=picture&format=json").success(function(response){deferred.resolve(response.picture.data.url)}).error(function(){}),deferred.promise}return{fetchFeed:fetchFeed,getAccessToken:getAccessToken,getProfilePicture:getProfilePicture}}),app.factory("FavoriteService",function($rootScope,$resource,GLOBAL,DBService,UserService){function add(artistId){var sql="INSERT OR IGNORE INTO favorites (artist_id, user_id) VALUES(?,?)",params=[artistId,UserService.getUser().id];return DBService.query(sql,params).then(function(response){return response})["catch"](function(error){console.log(error)})}function remove(artistId){var sql="DELETE FROM favorites WHERE artist_id = ? AND user_id = ?",params=[artistId,UserService.getUser().id];return DBService.query(sql,params).then(function(response){return response})["catch"](function(error){console.log(error)})}function drop(){return DBService.query("DROP TABLE IF EXISTS favorites").then(function(result){return DBService.fetch(result)})}function getAll(){return DBService.query("SELECT * FROM favorites WHERE user_id ="+UserService.getUser().id).then(function(result){return DBService.fetchAll(result)})}function getArtistById(id){return DBService.query("SELECT * FROM favorites WHERE artist_id = ? AND user_id = ?",[id,UserService.getUser().id]).then(function(result){return result.rows.length>0?DBService.fetch(result):!1})["catch"](function(error){console.log(error)})}var resource=$resource(GLOBAL.api.url+GLOBAL.api.version+"/favorites",{},{getAll:{method:"GET",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/favorites/"+UserService.getUserId()},create:{method:"POST",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/favorites/"+UserService.getUserId()},"delete":{method:"DELETE",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/favorites/"+UserService.getUserId()}});return{resource:resource,add:add,remove:remove,drop:drop,getAll:getAll,getArtistById:getArtistById}}),app.factory("InstagramService",function($rootScope,$q,$http,GLOBAL){var endPoint="https://api.instagram.com/v1/users/"+GLOBAL.instagram.user_id+"/media/recent/?client_id="+GLOBAL.instagram.client_id+"&callback=JSON_CALLBACK",items=[],nextUrl=0,NewInsta=0;return{GetFeed:function(){return $http.jsonp(endPoint).then(function(response){return console.info("instagram",response.data.data),items=response.data.data,nextUrl=response.data.pagination.next_url,NewInsta=response.data.pagination.next_max_id,items})},GetNewPhotos:function(){return $http.jsonp(endPoint+"&min_tag_id="+NewInsta).then(function(response){return items=response.data.data,response.data.data.length>0&&(NewInsta=response.data.pagination.next_max_id),items})},GetOldPhotos:function(){if("undefined"!=typeof nextUrl)return $http.jsonp(endPoint+"&max_tag_id="+nextUrl).then(function(response){return response.data.data.length>0&&(nextUrl=response.data.pagination.next_url),items=response.data.data});var deferred=$q.defer();return deferred.resolve([]),deferred.promise}}}),app.factory("MapService",function($rootScope,$resource,GLOBAL,DBService){function add(map){var sql="INSERT OR IGNORE INTO maps (name, image, latitude, longitude) VALUES(?,?,?,?)",params=[map.name,map.image,map.latitude,map.longitude];return DBService.query(sql,params).then(function(response){return response})["catch"](function(error){console.log(error)})}function addLocation(location){var sql="INSERT OR IGNORE INTO locations (name, image, detail, latitude, longitude) VALUES(?,?,?,?,?)",params=[location.name,location.detail,location.image,location.latitude,location.longitude];return DBService.query(sql,params).then(function(response){return response})["catch"](function(error){console.log(error)})}function drop(){return DBService.query("DROP TABLE IF EXISTS maps").then(function(result){return DBService.fetch(result)})}function getAll(){return DBService.query("SELECT * FROM maps").then(function(result){return DBService.fetchAll(result)})}function getAllLocations(id){return DBService.query("SELECT * FROM locations").then(function(result){return DBService.fetchAll(result)})}var resource=$resource(GLOBAL.api.url+GLOBAL.api.version+"/maps",{},{getAll:{method:"GET",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/maps/"+GLOBAL.api.feast}});return{resource:resource,add:add,addLocation:addLocation,drop:drop,getAll:getAll,getAllLocations:getAllLocations}}),app.factory("MusicService",function($rootScope){function add(track,toPlaylist){var audio=new Audio;audio.id=id,audio.src=track.url,audio.title=track.name,audio.artist=track.artist,audio.addEventListener("play",function(){console.info("music:play",track),$rootScope.$broadcast("music:play",track)}),audio.addEventListener("pause",function(){console.info("music:pause",track),$rootScope.$broadcast("music:pause",track)}),toPlaylist?(audio.addEventListener("ended",function(){console.info("music:next",track),next()}),setCurrentId(0)):(audio.addEventListener("ended",function(){console.info("music:ended",track),$rootScope.$broadcast("music:ended",track)}),setCurrentId(id)),tracks.push(audio),nextId()}function play(id){id>=0?(pause(),tracks[id].play(),setCurrentId(id)):tracks.length>0&&tracks[currentId].play()}function pause(){tracks.length>0&&tracks[currentId].pause()}function clear(){pause(),tracks=[],id=0}function next(){var last=getLastId()-1;setCurrentId(getCurrentId()<last?getCurrentId()+1:0),play()}function nextId(){id+=1}function getLastId(){return id}function getCurrentId(){return currentId}function setCurrentId(id){currentId=id}var tracks=[],id=0,currentId=0;return{add:add,clear:clear,play:play,pause:pause,getLastId:getLastId}}),app.factory("NotificationService",function($rootScope,$resource,GLOBAL,$http,$q,$ionicLoading){function register(device_token){var deferred=$q.defer();return $ionicLoading.show(),$http.post(base_url+"/register",{device_token:device_token}).success(function(response){$ionicLoading.hide(),deferred.resolve(response)}).error(function(data){deferred.reject()}),deferred.promise}var resource=$resource(GLOBAL.api.url+GLOBAL.api.version+"/notifications",{},{getAll:{method:"GET",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/notifications/"+GLOBAL.api.feast}}),base_url="http://{YOUR SERVER}";return{resource:resource,register:register}}),app.factory("PosterService",function($rootScope,$resource,GLOBAL,DBService){function add(poster){var sql="INSERT OR IGNORE INTO posters (id, image) VALUES(?,?)",params=[poster.id,poster.name];return DBService.query(sql,params).then(function(response){return response})["catch"](function(error){console.log(error)})}function drop(){return DBService.query("DROP TABLE IF EXISTS posters").then(function(result){return DBService.fetch(result)})}function get(){return DBService.query("SELECT * FROM posters ORDER BY id DESC LIMIT 1").then(function(result){return DBService.fetchAll(result)})}var resource=$resource(GLOBAL.api.url+GLOBAL.api.version+"/posters",{},{getAll:{method:"GET",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/posters/"+GLOBAL.api.feast}});return{resource:resource,add:add,drop:drop,get:get}}),app.factory("SpotifyService",function($rootScope,Spotify,GLOBAL,$q){function getTopTracks(spotifyId){return Spotify.getArtistTopTracks(spotifyId,GLOBAL.spotify.country_iso).then(function(data){return data.tracks})}function gerPlayList(){return Spotify.getPlaylist(GLOBAL.spotify.user_id,GLOBAL.spotify.playlist_id).then(function(data){return data})}return{getTopTracks:getTopTracks,gerPlayList:gerPlayList}}),app.factory("TimeService",function($rootScope,GLOBAL,$http,$q,$localStorage){return{dhms:function(t){var days,hours,minutes,seconds;days=Math.floor(t/86400),t-=86400*days,hours=Math.floor(t/3600)%24,t-=3600*hours,minutes=Math.floor(t/60)%60,t-=60*minutes,seconds=t%60;var hoursTotal=hours+24*days;return[hoursTotal+" horas",minutes+" minutos"].join(" ")}}}),app.factory("TwitterService",function($cordovaOauth,$cordovaOauthUtility,$http,$resource,$q,$localStorage,$twitterApi){function storeUserToken(data){$localStorage.twAccessToken=JSON.stringify(data)}function getStoredToken(){return $localStorage.twAccessToken}function getTimeLine(){var params={};return params.screen_name="lesartsfest",$twitterApi.getUserTimeline(params).then(function(data){return data},function(error){return error})}var clientId="EUWrUcoeBsyc3WXcCeL7y3Cvl",clientSecret="1Dx2MY7zbypUPVK7anjIaTEb3fKxuwbeyC7mEV7MFvEULvJhz5";return{initialize:function(){var deferred=$q.defer(),token=getStoredToken();return"undefined"==typeof token?$cordovaOauth.twitter(clientId,clientSecret).then(function(response){storeUserToken(response),deferred.resolve(!0),$twitterApi.configure(clientId,clientSecret,response)},function(error){console.info("error",error),deferred.reject(!1)}):($twitterApi.configure(clientId,clientSecret,token),deferred.resolve(!0)),deferred.promise},isAuthenticated:function(){return"undefined"!=typeof getStoredToken()},getTimeLine:getTimeLine}}),app.factory("UserService",function($rootScope,$resource,GLOBAL,$localStorage,$ionicPopup){function isLogged(){return"undefined"==typeof $localStorage.user?!1:"undefined"==typeof $localStorage.user.access_token?!1:!0}function getUser(){return $localStorage.user}function getUserId(){return isLogged()?getUser().id:0}function setUser(user){$localStorage.user=user}function logout(){$localStorage.user={}}function validateEmail(email){var pattern=/^([a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+(\.[a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+)*|"((([ \t]*\r\n)?[ \t]+)?([\x01-\x08\x0b\x0c\x0e-\x1f\x7f\x21\x23-\x5b\x5d-\x7e\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|\\[\x01-\x09\x0b\x0c\x0d-\x7f\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))*(([ \t]*\r\n)?[ \t]+)?")@(([a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.)+([a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.?$/i;return pattern.test(email)}function registerDevice(data){var deferred=$q.defer();return $http({method:"POST",url:SERVER_CONF.HOST+"device.json",data:serialize(data),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(rsp){rsp.success?deferred.resolve(rsp):deferred.reject(rsp)}).error(function(){deferred.reject({message:"El servidor no responde intente mas tarde"})}),deferred.promise}function registerNotifications(){if(window.PushNotification){var PushNotification=window.PushNotification,push=PushNotification.init({android:{senderID:"140186210091",icon:"festival",iconColor:"lightgrey"},ios:{alert:"true",badge:"true",sound:"true"},windows:{}});(null===getUser().device_token||void 0===getUser().device_token)&&push.on("registration",function(data){var os="0";ionic.Platform.isIOS()&&(os="1"),$localStorage.device_token=data.registrationId,registerDevice({access_token:getUser().access_token,os:os,device_token:data.registrationId})}),push.on("notification",function(data){$ionicPopup.alert({title:data.title,template:data.message})}),push.on("error",function(e){console.log("error",e)})}}var resource=$resource(GLOBAL.api.url+GLOBAL.api.version+"/users",{},{register:{method:"POST",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/users/"},login:{method:"POST",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/authentications/"},updatePassword:{method:"PUT",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/user/"},recoverPassword:{method:"PUT",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/authentication/"}});return{resource:resource,isLogged:isLogged,validateEmail:validateEmail,getUser:getUser,getUserId:getUserId,setUser:setUser,logout:logout,registerNotifications:registerNotifications}}),app.factory("VersionService",function($rootScope,$resource,GLOBAL,DBService){var resource=$resource(GLOBAL.api.url+GLOBAL.api.version+"/versions",{},{get:{method:"GET",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/versions/"+GLOBAL.api.feast}});return{resource:resource}}),app.factory("WeatherService",function($rootScope,$resource,GLOBAL,DBService){var resource=$resource(GLOBAL.api.url+GLOBAL.api.version+"/weathers",{},{getAll:{method:"GET",isArray:!1,url:GLOBAL.api.url+GLOBAL.api.version+"/weathers/"+GLOBAL.api.feast}});return{resource:resource}});